# AI-CRM 项目测试计划

> **Test Plan** | 测试策略与执行计划 | 更新日期：2024-11-06

---

## 📋 测试计划概览

**项目名称**：AI-CRM Serverless 重构  
**测试负责人**：AI Agent  
**测试周期**：贯穿所有开发阶段  
**质量目标**：测试覆盖率 ≥ 80%，关键路径 100% 覆盖

---

## 🎯 测试目标

1. **功能完整性**：验证所有功能符合需求规格说明
2. **接口正确性**：确保 API 响应符合接口契约
3. **数据准确性**：验证业务逻辑和算法计算正确
4. **性能达标**：确保响应时间和吞吐量满足要求
5. **安全可靠**：验证认证、授权和数据保护机制
6. **用户体验**：确保 UI 交互流畅、响应式正常

---

## 🧪 测试类型与策略

### 1. 单元测试（Unit Testing）

**工具**：Vitest  
**覆盖范围**：
- 工具函数（JWT、验证、日志等）
- 业务逻辑服务层
- 算法实现（提醒、统计）

**执行时机**：每次代码提交  
**覆盖率目标**：≥ 80%  

**测试用例设计原则**：
- 正常路径（Happy Path）
- 边界条件
- 异常情况
- 错误处理

**示例测试场景**：
```javascript
describe('JWT Utils', () => {
  test('createAccessToken should return valid token', () => {
    const user = { id: 1, name: 'admin' };
    const token = createAccessToken(user);
    expect(token).toBeDefined();
    expect(typeof token).toBe('string');
  });

  test('verifyAccessToken should decode valid token', () => {
    const user = { id: 1, name: 'admin' };
    const token = createAccessToken(user);
    const decoded = verifyAccessToken(token);
    expect(decoded.id).toBe(1);
    expect(decoded.name).toBe('admin');
  });

  test('verifyAccessToken should return null for invalid token', () => {
    const decoded = verifyAccessToken('invalid.token.here');
    expect(decoded).toBeNull();
  });
});
```

---

### 2. 接口测试（API Testing）

**工具**：Supertest + Vitest, Postman  
**覆盖范围**：所有 REST API 端点  

**测试维度**：
- 状态码验证
- 响应体结构验证
- 数据类型验证
- 错误处理验证
- 认证授权验证

**测试用例矩阵**：

| 接口 | 正常场景 | 无权限 | 参数错误 | 数据不存在 | 限流 |
| --- | --- | --- | --- | --- | --- |
| POST /api/auth/login | ✓ | N/A | ✓ | ✓ | ✓ |
| POST /api/auth/refresh | ✓ | N/A | ✓ | ✓ | N/A |
| GET /api/customers | ✓ | ✓ | ✓ | N/A | ✓ |
| POST /api/customers | ✓ | ✓ | ✓ | N/A | ✓ |
| GET /api/customers/:id | ✓ | ✓ | N/A | ✓ | N/A |
| PUT /api/customers/:id | ✓ | ✓ | ✓ | ✓ | ✓ |
| DELETE /api/customers/:id | ✓ | ✓ | N/A | ✓ | N/A |
| ... | ... | ... | ... | ... | ... |

**执行时机**：每个 Phase 完成时  

---

### 3. 集成测试（Integration Testing）

**工具**：Supertest + Vitest  
**覆盖范围**：跨模块业务流程  

**核心测试场景**：

#### 场景 1：完整客户管理流程
```
1. 登录系统
2. 创建客户
3. 查询客户列表（验证新客户存在）
4. 获取客户详情
5. 更新客户信息
6. 删除客户
7. 验证客户已删除
```

#### 场景 2：回访与意向更新流程
```
1. 创建客户（意向=C）
2. 创建回访记录（意向=A）
3. 验证客户意向自动更新为 A
4. 查询回访列表
5. 更新回访记录
6. 删除回访记录
```

#### 场景 3：订单与跟进日期流程
```
1. 创建客户
2. 创建产品订单（不填写 followUpDate）
3. 验证 followUpDate 自动设为 purchaseDate + 90 天
4. 查询仪表盘，验证统计数据更新
5. 查询提醒列表，验证产品回访提醒出现
```

#### 场景 4：备份恢复流程
```
1. 创建测试数据（客户、回访、订单）
2. 执行备份
3. 修改/删除部分数据
4. 执行恢复
5. 验证数据恢复到备份时状态
```

**执行时机**：Phase 2-5 完成时  

---

### 4. E2E 测试（End-to-End Testing）

**工具**：Playwright / Cypress  
**覆盖范围**：用户核心操作路径  

**测试场景**：

#### E2E-01：登录与仪表盘
```
1. 打开登录页
2. 输入用户名 admin
3. 输入密码 admin123
4. 点击登录按钮
5. 验证跳转到仪表盘
6. 验证统计卡片显示
7. 验证图表渲染
8. 验证提醒列表显示
```

#### E2E-02：客户全流程
```
1. 登录系统
2. 点击"客户管理"
3. 点击"新增客户"
4. 填写客户表单
5. 点击保存
6. 验证客户列表中出现新客户
7. 点击客户姓名进入详情页
8. 点击"编辑"按钮
9. 修改客户信息
10. 点击保存
11. 验证信息已更新
```

#### E2E-03：回访记录
```
1. 登录系统
2. 进入客户详情页
3. 切换到"回访记录" Tab
4. 点击"新增回访"
5. 填写回访表单
6. 选择意向等级 A
7. 点击保存
8. 验证回访记录出现
9. 返回客户详情，验证意向更新为 A
```

#### E2E-04：订单管理
```
1. 登录系统
2. 进入客户详情页
3. 切换到"产品订单" Tab
4. 点击"新增订单"
5. 填写订单表单（不填写跟进日期）
6. 点击保存
7. 验证订单出现
8. 验证跟进日期自动计算
9. 返回仪表盘，验证统计更新
```

#### E2E-05：深色模式
```
1. 登录系统
2. 点击深色模式切换按钮
3. 验证所有页面背景变暗
4. 验证文本颜色变亮
5. 刷新页面，验证偏好保持
6. 切换回浅色模式
7. 验证样式恢复
```

#### E2E-06：响应式测试
```
1. 登录系统（Desktop 视图）
2. 调整浏览器宽度至 768px（Tablet）
3. 验证侧边栏折叠
4. 验证表格切换为卡片
5. 调整宽度至 375px（Mobile）
6. 验证顶部导航固定
7. 验证内容全屏显示
```

#### E2E-07：备份恢复
```
1. 登录系统
2. 进入"用户设置"页面
3. 点击"备份数据"按钮
4. 等待备份完成
5. 验证成功提示
6. 进入"客户管理"，删除所有客户
7. 返回"用户设置"
8. 点击"恢复数据"按钮
9. 选择刚才的备份文件
10. 确认恢复
11. 返回"客户管理"，验证数据已恢复
```

**执行时机**：Phase 6 完成时  
**执行频率**：每次发布前  

---

### 5. 性能测试（Performance Testing）

**工具**：k6 / Artillery  
**测试类型**：
- 负载测试（Load Testing）
- 压力测试（Stress Testing）
- 耐久测试（Endurance Testing）

**测试场景**：

#### 性能测试 1：API 响应时间
```
场景：模拟正常负载
- 并发用户：50
- 持续时间：5 分钟
- 请求分布：
  - 50% GET /api/customers
  - 20% GET /api/dashboard/statistics
  - 15% POST /api/customers
  - 10% GET /api/customers/:id
  - 5% PUT /api/customers/:id

验收标准：
- P50 响应时间 < 200ms
- P95 响应时间 < 500ms
- P99 响应时间 < 1000ms
- 错误率 < 0.1%
```

#### 性能测试 2：压力测试
```
场景：模拟高负载
- 并发用户：100 → 500（逐步增加）
- 持续时间：10 分钟
- 请求分布：同上

验收标准：
- 系统不崩溃
- 识别性能瓶颈
- 明确系统容量上限
```

#### 性能测试 3：限流验证
```
场景：验证限流机制
- 对 /api/auth/login 发起连续请求
- 请求频率：10 req/s
- 持续时间：2 分钟

验收标准：
- 5 次失败登录后触发 429
- 15 分钟后限流解除
```

**执行时机**：Phase 7 部署前  

---

### 6. 安全测试（Security Testing）

**测试项目**：

#### 安全测试 1：认证机制
- [ ] 未登录访问受保护接口返回 401
- [ ] 错误 Token 访问返回 401
- [ ] 过期 Token 访问返回 401
- [ ] Refresh Token 只能用于刷新接口
- [ ] 登录失败 5 次触发限流

#### 安全测试 2：授权机制
- [ ] 验证用户只能访问自己的数据
- [ ] 验证角色权限隔离（未来多租户）

#### 安全测试 3：输入验证
- [ ] SQL 注入防护（使用 ORM 参数化查询）
- [ ] XSS 防护（前端过滤、后端转义）
- [ ] CSRF 防护（Serverless 通常无 Session）
- [ ] 文件上传限制（大小、类型）

#### 安全测试 4：敏感数据保护
- [ ] 密码已加密存储（bcrypt）
- [ ] JWT Secret 未硬编码
- [ ] 环境变量未提交 Git
- [ ] 日志中无敏感信息

#### 安全测试 5：依赖安全
- [ ] npm audit 无高危漏洞
- [ ] 依赖包来源可信
- [ ] 定期更新依赖

**执行时机**：Phase 7 部署前  

---

### 7. 可访问性测试（Accessibility Testing）

**工具**：Lighthouse, axe DevTools  

**测试项目**：
- [ ] 键盘导航（Tab、Enter、Space）
- [ ] 屏幕阅读器兼容（ARIA 属性）
- [ ] 色彩对比度 ≥ 4.5:1
- [ ] 表单 Label 与输入框关联
- [ ] 错误提示清晰可读
- [ ] 图片提供 alt 文本
- [ ] 语义化 HTML 标签

**验收标准**：Lighthouse Accessibility ≥ 90  

**执行时机**：Phase 6 完成时  

---

### 8. 兼容性测试（Compatibility Testing）

**浏览器测试矩阵**：

| 浏览器 | 版本 | Desktop | Mobile |
| --- | --- | --- | --- |
| Chrome | 最新 | ✓ | ✓ |
| Firefox | 最新 | ✓ | ✓ |
| Safari | 最新 | ✓ | ✓ |
| Edge | 最新 | ✓ | - |

**设备测试**：
- iPhone 12/13/14（iOS Safari）
- Samsung Galaxy S21（Chrome）
- iPad Pro（Safari）

**分辨率测试**：
- 1920x1080（Desktop）
- 1366x768（Laptop）
- 768x1024（Tablet）
- 375x667（Mobile）

**执行时机**：Phase 6 完成时  

---

## 📊 测试执行计划

### Phase 0：项目初始化
- [ ] 环境连通性测试
- [ ] 健康检查接口测试
- [ ] 数据库连接测试
- [ ] 种子数据验证

### Phase 1：认证与客户模块
- [ ] JWT 工具单元测试
- [ ] 中间件单元测试
- [ ] 登录接口测试（正常/异常）
- [ ] 刷新 Token 接口测试
- [ ] 客户 CRUD 接口测试
- [ ] 客户搜索/过滤测试
- [ ] 限流机制测试
- [ ] 集成测试：登录→创建客户→查询

### Phase 2：回访与订单模块
- [ ] 回访 CRUD 接口测试
- [ ] 意向自动更新测试
- [ ] 产品 CRUD 接口测试
- [ ] 跟进日期自动计算测试
- [ ] 统计接口数据准确性测试
- [ ] 集成测试：客户→回访→订单流程

### Phase 3：仪表盘与提醒
- [ ] 统计算法单元测试
- [ ] 提醒算法单元测试
- [ ] 仪表盘接口测试
- [ ] Cron 任务功能测试
- [ ] 数据准确性验证

### Phase 4：预设数据管理
- [ ] 所有预设表 CRUD 测试
- [ ] 排序接口测试
- [ ] 数据校验规则测试

### Phase 5：用户设置与维护
- [ ] 用户设置 CRUD 测试
- [ ] 备份功能测试
- [ ] 恢复功能测试
- [ ] 清空数据功能测试
- [ ] 操作日志验证

### Phase 6：前端对接与优化
- [ ] 所有页面 UI 测试
- [ ] API 对接测试
- [ ] 深色模式测试
- [ ] 响应式测试
- [ ] E2E 测试套件执行
- [ ] Lighthouse 性能测试
- [ ] 可访问性测试
- [ ] 浏览器兼容性测试

### Phase 7：部署与发布
- [ ] 生产环境冒烟测试
- [ ] 性能测试（负载/压力）
- [ ] 安全测试
- [ ] 回归测试（完整功能）
- [ ] 7 天稳定性测试

---

## 📋 测试用例清单

### 认证模块测试用例

| 用例 ID | 测试场景 | 前置条件 | 操作步骤 | 期望结果 | 优先级 |
| --- | --- | --- | --- | --- | --- |
| AUTH-001 | 正确凭证登录 | 用户存在 | 输入 admin/admin123，点击登录 | 返回 200 + token | P0 |
| AUTH-002 | 错误用户名 | - | 输入 wronguser/admin123 | 返回 401 | P0 |
| AUTH-003 | 错误密码 | 用户存在 | 输入 admin/wrongpass | 返回 401 | P0 |
| AUTH-004 | 空用户名 | - | 用户名为空，点击登录 | 返回 400 + 验证错误 | P1 |
| AUTH-005 | 空密码 | - | 密码为空，点击登录 | 返回 400 + 验证错误 | P1 |
| AUTH-006 | 登录限流 | - | 连续 5 次错误登录 | 第 6 次返回 429 | P1 |
| AUTH-007 | Token 刷新 | 有效 refreshToken | 调用刷新接口 | 返回新 token | P0 |
| AUTH-008 | 过期 Token 访问 | Token 已过期 | 访问受保护接口 | 返回 401 | P0 |

### 客户模块测试用例

| 用例 ID | 测试场景 | 前置条件 | 操作步骤 | 期望结果 | 优先级 |
| --- | --- | --- | --- | --- | --- |
| CUS-001 | 获取客户列表 | 已登录 | GET /api/customers | 返回 200 + 客户数组 | P0 |
| CUS-002 | 创建客户（最小字段） | 已登录 | POST /api/customers {name} | 返回 201 + 客户对象 | P0 |
| CUS-003 | 创建客户（完整字段） | 已登录 | POST /api/customers {所有字段} | 返回 201 + 客户对象 | P1 |
| CUS-004 | 创建客户（缺少必填字段） | 已登录 | POST /api/customers {} | 返回 400 + 验证错误 | P1 |
| CUS-005 | 获取客户详情 | 客户存在 | GET /api/customers/1 | 返回 200 + 客户详情 | P0 |
| CUS-006 | 获取不存在的客户 | - | GET /api/customers/999 | 返回 404 | P1 |
| CUS-007 | 更新客户 | 客户存在 | PUT /api/customers/1 {name: "新名称"} | 返回 200 + 更新后对象 | P0 |
| CUS-008 | 删除客户 | 客户存在 | DELETE /api/customers/1 | 返回 200 | P0 |
| CUS-009 | 搜索客户（姓名） | 有客户数据 | GET /api/customers?search=张三 | 返回匹配客户 | P1 |
| CUS-010 | 过滤客户（分类） | 有客户数据 | GET /api/customers?category=vip | 返回 VIP 客户 | P1 |
| CUS-011 | 分页查询 | 有大量数据 | GET /api/customers?page=2&limit=20 | 返回第 2 页数据 | P1 |

*（其他模块测试用例省略，实际应包含所有模块）*

---

## 📊 测试覆盖率目标

| 层级 | 目标覆盖率 | 当前覆盖率 |
| --- | --- | --- |
| 单元测试 | ≥ 80% | __% |
| 接口测试 | 100%（所有端点） | __% |
| 集成测试 | 核心流程 100% | __% |
| E2E 测试 | 主要用户路径 | __/7 场景 |

---

## 📝 测试报告模板

### 阶段测试报告：Phase X

**测试周期**：YYYY-MM-DD ~ YYYY-MM-DD  
**测试负责人**：AI Agent  
**测试环境**：Local / Preview / Production

#### 测试执行概况
- 计划用例数：___
- 执行用例数：___
- 通过用例数：___
- 失败用例数：___
- 阻塞用例数：___
- 通过率：___%

#### 缺陷统计
- P0 缺陷：___ 个
- P1 缺陷：___ 个
- P2 缺陷：___ 个
- P3 缺陷：___ 个

#### 测试结论
⬜ 通过，可进入下一阶段  
⬜ 有条件通过，需修复关键缺陷  
⬜ 不通过，需重新测试

#### 遗留问题
- ISSUE-XXX：[描述]

#### 风险与建议
- [风险或建议]

---

## 🔄 测试自动化

### CI/CD 集成

**触发条件**：
- 每次 Git Push
- 每次 Pull Request
- 每日定时（夜间完整测试）

**Pipeline 步骤**：
```yaml
1. 代码检出
2. 安装依赖（使用缓存）
3. ESLint 检查
4. TypeScript 类型检查
5. 单元测试 + 覆盖率
6. 接口测试
7. 构建应用
8. E2E 测试（仅 main 分支）
9. 生成测试报告
10. 发送通知
```

**失败处理**：
- 阻止合并（PR）
- 通知开发者
- 记录失败日志

---

## 📋 使用说明

### 如何执行测试

**本地执行单元测试**：
```bash
npm run test              # 执行所有测试
npm run test:watch        # 监听模式
npm run test:coverage     # 生成覆盖率报告
```

**本地执行 E2E 测试**：
```bash
npm run test:e2e          # Playwright
npm run test:e2e:ui       # 打开 UI 模式
```

**执行性能测试**：
```bash
k6 run tests/performance/load-test.js
```

**查看测试报告**：
```bash
npm run test:report       # 打开 HTML 报告
```

---

**文档维护人**：AI Agent  
**最后更新**：2024-11-06  
**审查频率**：每个 Phase
