# 01｜项目需求规格说明

本文档作为 AI 可理解的功能规格说明书，覆盖**认证**、**客户管理**、**回访记录**、**产品订单**、**仪表盘统计**、**预设数据管理**与**用户设置**等全部业务域，并附上完整的接口契约、数据验证规则与业务约束。

---

## 1. 业务场景与目标用户

### 使用对象
- 单一管理员（或小型团队共用账号），负责客户资料录入、回访记录、订单管理与数据分析。

### 核心场景
1. **客户生命周期管理**：从初次接触到成交、复购，跟踪意向变化、预算需求、上下级联系人等信息。
2. **计划化回访**：设定回访日期与方式，记录回访内容、满意度；自动生成提醒列表。
3. **产品订单跟进**：记录购买的产品、购买日期、价格、售后时长；自动设定回访日期（默认 +90 天）。
4. **仪表盘可视化**：实时汇总月度销售额、订单数、新增客户、意向分布与提醒清单，为业务决策提供依据。

---

## 2. 功能模块清单

| 模块 | 路由前缀 | 主要功能点 |
| --- | --- | --- |
| **认证与授权** | `/api/auth` | 登录、登出、刷新 Token、修改密码 |
| **客户管理** | `/api/customers` | 客户 CRUD、分页查询、搜索、关联上下级联系人、计划回访字段 |
| **回访记录** | `/api/visits` | 回访 CRUD、按客户过滤、记录满意度与意向变化 |
| **产品订单** | `/api/products` | 订单 CRUD、自动计算跟进日期、销售统计 |
| **仪表盘统计** | `/api/dashboard` | 获取统计数据、意向分布、提醒聚合 |
| **客户分类** | `/api/customer-categories` | CRUD、排序 |
| **客户意向等级** | `/api/customer-intentions` | CRUD、排序、定义优先级 |
| **地区管理** | `/api/regions` | CRUD、排序 |
| **预算范围** | `/api/budget-ranges` | CRUD、排序 |
| **上级联系人** | `/api/superior-contacts` | CRUD、排序、标记是否直接上级 |
| **下级联系人** | `/api/subordinate-contacts` | CRUD、排序、标记是否直接下级 |
| **预设产品** | `/api/preset-products` | CRUD、排序、提供快速选择 |
| **回访方式** | `/api/visit-methods` | CRUD、枚举（电话、邮件、现场拜访等） |
| **回访类型** | `/api/visit-types` | CRUD、枚举（计划回访、产品回访、生日回访等） |
| **导航模式** | `/api/navigation-modes` | CRUD、定义地址跳转规则模板 |
| **提醒周期** | `/api/reminder-cycles` | CRUD、设定提前提醒天数 |
| **用户设置** | `/api/user-settings` | 深色模式、提醒开关、语言偏好 |
| **数据维护** | `/api/maintenance` | 备份、恢复、清空测试数据 |

---

## 3. 接口契约详细规格

### 3.1 认证与授权

#### 登录
- **URL**：`POST /api/auth/login`
- **请求体**：
  ```json
  {
    "username": "admin",
    "password": "admin123"
  }
  ```
- **成功响应**（200）：
  ```json
  {
    "success": true,
    "user": { "id": 1, "name": "admin" },
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs..."
  }
  ```
- **失败响应**（401）：`{ "error": "用户名或密码错误" }`
- **业务规则**：
  - 密码使用 bcrypt 加密存储，至少 8 位。
  - 登录失败 5 次/15 分钟触发限流（由 loginLimiter 中间件实现）。
  - 返回的 `token` 有效期 15 分钟，`refreshToken` 有效期 7 天。

#### 刷新 Token
- **URL**：`POST /api/auth/refresh`
- **请求体**：`{ "refreshToken": "..." }`
- **成功响应**（200）：返回新的 `token` 与 `refreshToken`。
- **失败响应**（401）：`{ "error": "刷新令牌无效或已过期" }`
- **规则**：只有 type=refresh 的 JWT 能通过验证。

#### 登出
- **URL**：`POST /api/auth/logout`
- **需认证**：是
- **响应**（200）：`{ "success": true, "message": "已登出" }`
- **规则**：当前基于 JWT 无状态认证，前端清除 localStorage 即可；未来可引入 Token 黑名单。

#### 修改密码
- **URL**：`POST /api/managers/change-password`
- **需认证**：是
- **请求体**：`{ "currentPassword": "...", "newPassword": "..." }`
- **成功响应**（200）：`{ "message": "密码修改成功" }`
- **失败响应**（400）：`{ "error": "当前密码错误" }`
- **规则**：新密码长度 ≥ 8，需使用 bcrypt 重新哈希。

---

### 3.2 客户管理

#### 获取客户列表
- **URL**：`GET /api/customers`
- **查询参数**：
  - `page`：页码（默认 1）
  - `limit`：每页数量（默认 20，最大 100）
  - `search`：按姓名、公司、手机号模糊搜索
  - `category`：客户分类过滤
  - `intention`：意向等级过滤
- **响应示例**：
  ```json
  {
    "data": [
      {
        "id": 1,
        "name": "张三",
        "phone": "13800138000",
        "email": "zhangsan@example.com",
        "company": "创新科技有限公司",
        "category": "vip",
        "intention": "H",
        "created_at": "2024-01-01T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "totalPages": 5
    }
  }
  ```

#### 获取客户详情
- **URL**：`GET /api/customers/:id`
- **响应**（200）：返回单个客户完整信息，含上下级联系人字段。
- **响应**（404）：`{ "error": "客户不存在" }`

#### 创建客户
- **URL**：`POST /api/customers`
- **需认证**：是
- **请求体**（必填字段）：
  ```json
  {
    "name": "客户姓名",
    "phone": "13912345678",
    "email": "example@example.com",
    "company": "公司名称",
    "category": "normal",
    "intention": "C",
    "gender": "男",
    "birthday": "1990-01-01",
    "address": "详细地址",
    "region": "华东",
    "demand": "需求描述",
    "wechat": "微信号",
    "whatsapp": "WhatsApp 号码",
    "facebook": "Facebook 主页",
    "budget": "10000-50000",
    "remark": "备注信息",
    "superiorContactId": 1,
    "subordinateContactIds": "2,3",
    "planned_visit_date": "2024-06-01",
    "planned_visit_method": "电话回访",
    "planned_visit_content": "计划回访内容"
  }
  ```
- **校验规则**：
  - `name`：非空，长度 1-100。
  - `phone`：正则匹配（可选）；不能与已有客户重复（业务规则）。
  - `email`：标准邮箱格式。
  - `birthday`：YYYY-MM-DD 格式。
  - `subordinateContactIds`：以逗号分隔的 ID 字符串（存储为 TEXT）。
- **成功响应**（201）：返回新创建的客户对象。

#### 更新客户
- **URL**：`PUT /api/customers/:id`
- **需认证**：是
- **请求体**：与创建客户相同字段，支持部分更新。
- **成功响应**（200）：返回更新后的客户对象。
- **失败响应**（404）：`{ "error": "客户不存在" }`

#### 删除客户
- **URL**：`DELETE /api/customers/:id`
- **需认证**：是
- **响应**（200）：`{ "message": "客户已删除" }`
- **业务规则**：级联删除关联的回访记录与产品订单。

---

### 3.3 回访记录

#### 获取回访列表
- **URL**：`GET /api/visits`
- **查询参数**：
  - `page` / `limit`：分页。
  - `customerId`：按客户过滤。
- **响应**：返回回访记录数组，含客户姓名。

#### 创建回访记录
- **URL**：`POST /api/visits`
- **需认证**：是
- **请求体**：
  ```json
  {
    "customerId": 1,
    "visitTime": "2024-05-01T14:00:00",
    "content": "回访内容",
    "effect": "良好",
    "satisfaction": "满意",
    "intention": "A",
    "followUp": "下次跟进计划"
  }
  ```
- **校验规则**：
  - `customerId`：必须存在于 Customers 表。
  - `visitTime`：ISO 8601 格式，不能早于客户创建日期（可选校验）。
  - `intention`：可选值 H / A / B / C / D。
- **成功响应**（201）：返回新建记录。

#### 更新回访
- **URL**：`PUT /api/visits/:id`
- **需认证**：是
- **成功响应**（200）：返回更新后的记录。

#### 删除回访
- **URL**：`DELETE /api/visits/:id`
- **需认证**：是
- **成功响应**（200）：`{ "message": "回访记录已删除" }`

---

### 3.4 产品订单

#### 获取产品列表
- **URL**：`GET /api/products`
- **查询参数**：`customerId`、`page`、`limit`。
- **响应**：返回订单数组，含客户姓名、产品名称、购买日期、跟进日期。

#### 创建产品订单
- **URL**：`POST /api/products`
- **需认证**：是
- **请求体**：
  ```json
  {
    "customerId": 1,
    "productName": "保湿滋养面霜",
    "quantity": 5,
    "price": 298.0,
    "purchaseDate": "2024-04-01",
    "afterSale": "1年质保",
    "followUpDate": "2024-07-01"
  }
  ```
- **业务规则**：
  - 若 `followUpDate` 为空，自动设为 `purchaseDate + 90天`。
  - `price` 与 `quantity` 需 > 0。
- **成功响应**（201）：返回新建订单。

#### 更新产品订单
- **URL**：`PUT /api/products/:id`
- **需认证**：是
- **成功响应**（200）：返回更新后订单。

#### 删除产品订单
- **URL**：`DELETE /api/products/:id`
- **需认证**：是
- **成功响应**（200）：`{ "message": "订单已删除" }`

#### 获取销售统计
- **URL**：`GET /api/products/statistics/summary`
- **需认证**：是
- **响应示例**：
  ```json
  {
    "totalRevenue": 25000.0,
    "totalOrders": 120,
    "averageOrderValue": 208.33,
    "topProducts": [
      { "productName": "保湿滋养面霜", "totalQuantity": 50, "totalRevenue": 14900.0 }
    ]
  }
  ```

---

### 3.5 仪表盘统计

#### 获取仪表盘数据
- **URL**：`GET /api/dashboard/statistics`
- **需认证**：是
- **响应示例**：
  ```json
  {
    "monthlySalesAmount": 10000.0,
    "monthlyOrderCount": 50,
    "averageOrderValue": 200.0,
    "monthlyNewCustomers": 10,
    "monthlyVisitCount": 30,
    "monthlyDealCustomers": 15,
    "intentionDistribution": {
      "H": 5,
      "A": 10,
      "B": 15,
      "C": 20,
      "D": 5
    },
    "importantReminders": [
      {
        "type": "计划回访",
        "customerId": 1,
        "customerName": "张三",
        "reminderDate": "2024-06-01",
        "content": "计划回访内容"
      },
      {
        "type": "产品回访",
        "customerId": 2,
        "customerName": "李四",
        "reminderDate": "2024-06-05",
        "productName": "保湿滋养面霜"
      },
      {
        "type": "客户生日",
        "customerId": 3,
        "customerName": "王五",
        "birthday": "1990-06-10"
      }
    ]
  }
  ```
- **业务规则**：
  - 月度数据仅统计当月 1 日至当前日期。
  - 提醒包含：计划回访（planned_visit_date）、产品回访（followUpDate）、客户生日（birthday），默认展示最近 30 天内的。
  - 提醒按日期升序排序。

---

### 3.6 预设数据管理

所有预设数据接口共享相同的增删改查模式，且支持排序。

#### 通用 CRUD 接口模式

| 操作 | 方法 + 路由 | 说明 |
| --- | --- | --- |
| 获取列表 | `GET /api/<preset-name>` | 按 `displayOrder` 升序返回 |
| 获取单条 | `GET /api/<preset-name>/:id` | 返回单条记录 |
| 创建 | `POST /api/<preset-name>` | 必填字段 `name`，可选 `description` / `displayOrder` |
| 更新 | `PUT /api/<preset-name>/:id` | 更新字段 |
| 删除 | `DELETE /api/<preset-name>/:id` | 删除记录 |
| 重新排序 | `POST /api/<preset-name>/reorder` | 请求体 `{ "ids": [3, 1, 2] }`，按数组顺序更新 `displayOrder` |

#### 客户分类（Customer Categories）
- **路由**：`/api/customer-categories`
- **字段**：`id`（TEXT 主键，如 "vip"）、`name`、`description`、`displayOrder`。

#### 客户意向等级（Customer Intentions）
- **路由**：`/api/customer-intentions`
- **字段**：`level`（TEXT 主键，如 "H" / "A" / "B" / "C" / "D"）、`name`、`description`、`criteria`、`followUpPriority`、`displayOrder`。

#### 地区（Regions）
- **路由**：`/api/regions`
- **字段**：`id`（TEXT 主键）、`name`、`displayOrder`。

#### 预算范围（Budget Ranges）
- **路由**：`/api/budget-ranges`
- **字段**：`id`（TEXT 主键）、`name`（如 "10000-50000"）、`displayOrder`。

#### 上级联系人（Superior Contacts）
- **路由**：`/api/superior-contacts`
- **字段**：`id`（INTEGER 自增）、`name`、`company`、`isDirect`（BOOLEAN）、`displayOrder`。

#### 下级联系人（Subordinate Contacts）
- **路由**：`/api/subordinate-contacts`
- **字段**：同上级联系人。

#### 预设产品（Preset Products）
- **路由**：`/api/preset-products`
- **字段**：`id`、`productName`、`price`、`description`、`displayOrder`。

#### 回访方式（Visit Methods）
- **路由**：`/api/visit-methods`
- **字段**：`id`、`name`、`description`、`displayOrder`。

#### 回访类型（Visit Types）
- **路由**：`/api/visit-types`
- **字段**：`id`、`name`、`description`、`displayOrder`。

#### 导航模式（Navigation Modes）
- **路由**：`/api/navigation-modes`
- **字段**：`id`、`name`、`urlPattern`（如 `https://www.google.com/maps?q={Address}`）、`displayOrder`。

#### 提醒周期（Reminder Cycles）
- **路由**：`/api/reminder-cycles`
- **字段**：`id`、`name`（如 "3天内"）、`days`（提前天数）、`displayOrder`。

---

### 3.7 用户设置

#### 获取设置
- **URL**：`GET /api/user-settings`
- **需认证**：是
- **响应**（200）：
  ```json
  {
    "id": 1,
    "darkMode": false,
    "visitReminder": true,
    "birthdayReminder": false,
    "language": "zh-CN",
    "lastBackup": "2024-05-01T10:00:00Z"
  }
  ```

#### 更新设置
- **URL**：`PUT /api/user-settings`
- **需认证**：是
- **请求体**：支持部分更新。
- **成功响应**（200）：返回更新后的设置对象。

#### 更新深色模式
- **URL**：`PUT /api/user-settings/dark-mode`
- **请求体**：`{ "enabled": true }`
- **成功响应**（200）。

#### 更新通知设置
- **URL**：`PUT /api/user-settings/notification`
- **请求体**：`{ "type": "visitReminder", "enabled": true }`
- **成功响应**（200）。

---

### 3.8 数据维护

#### 备份数据库
- **URL**：`POST /api/maintenance/backup`
- **需认证**：是
- **响应**（200）：
  ```json
  {
    "success": true,
    "fileName": "backup_2024-05-01_10-00-00.sql",
    "timestamp": "2024-05-01T10:00:00Z"
  }
  ```
- **规则**：生成 SQL 备份文件或导出至云存储（如 Vercel Blob / R2）。

#### 恢复数据
- **URL**：`POST /api/maintenance/restore`
- **需认证**：是
- **请求体**：`{ "fileName": "backup_2024-05-01_10-00-00.sql" }`（可选，默认恢复最新备份）。
- **响应**（200）：`{ "success": true, "message": "恢复成功" }`。

#### 清空测试数据
- **URL**：`POST /api/maintenance/clear-data`
- **需认证**：是
- **响应**（200）：`{ "success": true, "message": "已清空所有客户、回访与订单数据" }`。
- **规则**：仅删除业务数据，保留管理员账户与预设配置。

---

## 4. 数据模型约束

| 表名 | 主键 | 关键字段 | 索引要求 |
| --- | --- | --- | --- |
| Customers | `id` (SERIAL) | `name`, `phone`, `email`, `category`, `intention`, `superiorContactId`, `subordinateContactIds` | `phone`, `email`, `category`, `intention`, `created_at` |
| Products | `id` (SERIAL) | `customerId`, `productName`, `purchaseDate`, `followUpDate` | `customerId`, `purchaseDate`, `followUpDate` |
| Visits | `id` (SERIAL) | `customerId`, `visitTime`, `intention` | `customerId`, `visitTime` |
| Managers | `id` (SERIAL) | `name`, `password` | `name` (唯一) |
| CustomerCategories | `id` (TEXT) | `name`, `displayOrder` | `displayOrder` |
| CustomerIntentions | `level` (TEXT) | `name`, `displayOrder` | `displayOrder` |
| SuperiorContacts | `id` (SERIAL) | `name`, `displayOrder` | `displayOrder` |
| SubordinateContacts | `id` (SERIAL) | `name`, `displayOrder` | `displayOrder` |
| PresetProducts | `id` (SERIAL) | `productName`, `price`, `displayOrder` | `displayOrder` |
| UserSettings | `id` (INTEGER) | `darkMode`, `visitReminder`, `birthdayReminder`, `language` | - |
| VisitMethods | `id` (SERIAL) | `name`, `displayOrder` | `displayOrder` |
| VisitTypes | `id` (SERIAL) | `name`, `displayOrder` | `displayOrder` |
| NavigationModes | `id` (SERIAL) | `name`, `urlPattern`, `displayOrder` | `displayOrder` |
| ReminderCycles | `id` (SERIAL) | `name`, `days`, `displayOrder` | `displayOrder` |

> 所有表均包含 `created_at` 与 `updated_at` 时间戳字段（除预设表外可选）。

---

## 5. 非功能需求

| 项 | 要求 |
| --- | --- |
| 响应时间 | 列表查询 < 500ms，详情查询 < 200ms，写操作 < 1s |
| 分页支持 | 默认每页 20 条，最大 100 条 |
| 并发限流 | 全局 100 req/min，登录 5 req/15min，敏感操作（修改密码、清空数据）10 req/hour |
| 安全加固 | bcrypt 哈希密码（cost=10）；JWT 签名；Helmet 安全头；SQL 注入与 XSS 过滤 |
| 日志追踪 | 所有请求记录 IP、User-Agent、时间戳、方法、路径、响应码、耗时 |
| 错误处理 | 统一返回 `{ "error": "..." }` 格式；4xx 客户端错误、5xx 服务器错误 |

---

## 6. 数据初始化（Seed）

系统首次部署需插入以下默认数据：

### 管理员账户
- 用户名：`admin`
- 密码：`admin123`（哈希后存储）

### 预设数据示例
- 客户分类：普通客户、VIP客户、企业客户、代理商、潜在客户
- 意向等级：H（高意向）、A（有意向）、B（一般）、C（低意向）、D（无意向）
- 地区：华东、华南、华北、华中、西南、西北、东北
- 预算范围：1000-5000、5000-10000、10000-50000、50000-100000、100000+
- 回访类型：计划回访、产品回访、客户生日、其他回访
- 提醒周期：今天、3天内、7天内、15天内、30天内、90天内、180天内、360天内

---

本文档为 AI 提供了完整的业务规则与接口契约，可直接映射为 OpenAPI 规范或生成代码骨架。
