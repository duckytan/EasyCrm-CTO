# 00｜快速开始指南

本指南为 AI 智能体或工程师提供端到端的环境搭建、数据库初始化、Serverless 部署与常见调试流程，确保能够快速启动 AI-CRM Serverless 版本的重新研发。

---

## 1. 目标形态速览

- **代码结构**：采用 `app/`（前端静态资源）+ `api/`（Serverless Functions）分层。
- **运行平台**：默认部署到 **Vercel**，兼容其他 Serverless 平台（Netlify Functions、Cloudflare Workers*）。
- **数据库**：推荐使用 **Vercel Postgres** 或兼容 Postgres 语法的云数据库（Neon、Supabase）。
- **语言与运行时**：Node.js 18+；可选 TypeScript。
- **环境变量**：集中在 `.env.local`（本地）与 Vercel 环境配置中。

---

## 2. 目录结构（目标形态）

```
project-root/
├── app/                      # 静态前端或 SPA（可选迁移到 Next.js App Router）
│   ├── public/               # 纯静态资源（直接托管）
│   └── src/                  # 若引入构建工具的源码目录
├── api/                      # Vercel Serverless Functions
│   ├── auth/                 # 认证相关函数（登录、刷新 token、登出）
│   ├── customers/            # 客户 CRUD
│   ├── visits/               # 回访 CRUD + 聚合
│   ├── products/             # 产品订单 CRUD + 统计
│   ├── dashboard/            # 仪表盘统计
│   ├── presets/              # 预设数据（分类、意向、预算等）
│   ├── settings/             # 用户设置、备份、恢复
│   ├── utils/                # 通用中间件、响应封装
│   └── db/                   # 数据库客户端、schema、seed
├── prisma/ or drizzle/       # 数据建模工具目录（视选型而定）
├── package.json
├── vercel.json               # Vercel 项目配置（函数运行时、路由重写）
├── .env.example
└── doc_move/                 # 本次生成的文档合集
```

---

## 3. 环境准备

| 依赖 | 要求 | 用途 |
| --- | --- | --- |
| Node.js | ≥ 18.17 | Vercel 默认运行时，与 Edge Function 兼容 |
| npm / pnpm | 最新 LTS | 包管理器；推荐 pnpm 以提升安装速度 |
| Vercel CLI | `npm i -g vercel` | 部署与本地 `vercel dev` 模拟 |
| Git | 任意稳定版 | 拉取与推送代码 |
| PostgreSQL 客户端 | `psql` 或 TablePlus | 手动验证数据库时使用（可选） |

---

## 4. 环境变量清单

| 名称 | 示例值 | 说明 |
| --- | --- | --- |
| `DATABASE_URL` | `postgres://user:pass@host:5432/ai_crm` | Postgres 连接串，兼容 SSL 参数 |
| `DIRECT_URL` *(可选)* | `postgres://...` | Prisma 用于迁移的直连地址 |
| `JWT_SECRET` | 64 位随机字符串 | Access Token 签名密钥 |
| `JWT_REFRESH_SECRET` | 64 位随机字符串 | Refresh Token 签名密钥 |
| `JWT_EXPIRES_IN` | `15m` | Access Token 过期时间 |
| `JWT_REFRESH_EXPIRES_IN` | `7d` | Refresh Token 过期时间 |
| `RATE_LIMIT_REQUESTS` | `100` | 通用限流阈值（每分钟） |
| `RATE_LIMIT_WINDOW` | `60` | 限流窗口（秒） |
| `LOG_LEVEL` | `info` | 日志级别（`debug` / `info` / `warn` / `error`） |
| `BACKUP_BUCKET_URL` *(可选)* | `https://...` | 云存储备份地址（如使用 R2 / S3） |

> 在 Vercel 中使用 `vercel env add` 逐项写入，或通过仪表盘粘贴。

---

## 5. 初始化流程（本地）

1. **克隆仓库**
   ```bash
   git clone <repo-url>
   cd project-root
   ```

2. **安装依赖**
   ```bash
   npm install
   # 或 pnpm install / yarn install
   ```

3. **创建环境变量文件**
   ```bash
   cp .env.example .env.local
   # 根据上表补齐取值，放置在项目根目录
   ```

4. **数据库建表与迁移**（以 Prisma 为例）
   ```bash
   npx prisma migrate dev --name init
   npx prisma db seed
   ```
   - 若使用 Drizzle：`npx drizzle-kit generate && npx drizzle-kit push`。
   - 提供的 `seed` 脚本需插入默认管理员、预设数据。

5. **本地调试（Vercel 模拟）**
   ```bash
   vercel dev
   ```
   - 默认监听 `http://localhost:3000`。
   - 前端静态页面可通过 `http://localhost:3000/` 访问。
   - API 通过 `http://localhost:3000/api/...` 访问，与线上保持一致。

6. **测试健康检查**
   ```bash
   curl http://localhost:3000/api/health
   ```
   期望响应：`{ "status": "ok", "timestamp": "..." }`。

---

## 6. 数据库准备（Vercel Postgres 示例）

1. **创建数据库**
   - 在 Vercel Dashboard -> Storage -> Postgres -> Create Database。
2. **复制连接串**
   - 在数据库详情页复制 `Prisma` 或 `Connection Pooling` URL。
3. **写入环境变量**
   ```bash
   vercel env add DATABASE_URL
   vercel env add JWT_SECRET
   vercel env add JWT_REFRESH_SECRET
   # ... 依次添加
   ```
4. **远程迁移与种子数据**
   ```bash
   vercel env pull .env.production.local
   npx prisma migrate deploy --schema prisma/schema.prisma
   npx prisma db seed --schema prisma/schema.prisma
   ```

> 如选择 Neon / Supabase，步骤基本一致，仅需更新连接串及 SSL 参数。

---

## 7. 部署流程（Vercel）

1. **登录 Vercel CLI**：`vercel login`
2. **首次部署**：`vercel`（按提示选择项目、环境、框架）
3. **配置别名**（可选）：
   ```bash
   vercel alias <deployment-url> ai-crm-serverless.vercel.app
   ```
4. **生产部署**：
   ```bash
   vercel --prod
   ```
5. **验证**：访问生产域名的 `/` 与 `/pages/dashboard`、`/api/health`。

> 建议启用 Vercel 自动化：连接 GitHub 后，`main` 分支自动触发生产部署，feature 分支生成 Preview URL。

---

## 8. 常用脚本与命令

| 命令 | 作用 |
| --- | --- |
| `npm run lint` | 运行 ESLint（如使用 TypeScript 建议加入） |
| `npm run format` | 执行 Prettier 保持格式统一 |
| `npm run test` | 运行单元 / 集成测试（需补充测试框架） |
| `npm run seed` | 手动执行数据库种子脚本 |
| `vercel dev` | 本地模拟 Serverless + Edge 环境 |
| `vercel env pull` | 拉取远程环境变量到本地文件 |

---

## 9. 故障排查速查表

| 场景 | 原因排查 | 建议解决方案 |
| --- | --- | --- |
| `vercel dev` 访问 500 | 环境变量缺失、数据库连接失败 | 检查 `.env.local` 是否配置，确认数据库可连通 |
| Serverless 函数冷启动慢 | 依赖过大、bundle 未 tree-shaking | 使用 `@vercel/ncc` 打包、拆分函数依赖、按需导入 |
| 数据库超时 | 连接池设置不当 | 使用 Vercel 提供的 pooled URL，并配置合理的 `pg` 客户端超时 |
| JWT 校验失败 | Secret 不一致 | 确保本地与线上 `JWT_SECRET` / `JWT_REFRESH_SECRET` 一致 |
| 预设数据缺失 | 未运行 seed 脚本 | 执行 `npm run seed` 或 `prisma db seed` |

---

## 10. 后续阅读建议

1. 阅读 `01_项目需求规格说明.md` 获取完整业务与接口约束。
2. 阅读 `02_技术架构设计文档.md` 明确 Serverless 模块划分与数据流。
3. 按 `05_重新开发任务规划.md` 中的阶段任务逐步实施。
