# 06｜开发建议与最佳实践

本指南总结了在 Serverless 架构下重构 AI-CRM 系统时的技术建议、性能调优、安全策略与协作流程，帮助 AI 智能体与开发团队输出高质量成果。

---

## 1. Serverless 开发通用建议

1. **按需加载依赖**：每个函数独立部署，确保只引入所需依赖，避免冗余代码导致冷启动延迟。
2. **共享代码复用**：将公共逻辑放在 `api/utils/`，避免跨函数复制；利用 Vercel 的层级缓存共享文件。
3. **环境变量管理**：本地使用 `.env.local`，生产使用 Vercel Dashboard；通过 `vercel env pull` 同步。
4. **数据库连接池**：务必使用连接池或 Prisma Data Proxy，防止 "too many connections"。
5. **无状态原则**：函数间不共享内存状态，如需共享信息，请写入数据库或缓存。

---

## 2. 代码规范与结构

| 项目 | 建议 |
| --- | --- |
| 文件命名 | 全小写、使用连字符或中括号（如 `customers/[id].ts`） |
| 导出方式 | Serverless 函数使用默认导出 `export default async function handler(req)` |
| 中间件 | 通过高阶函数组合：`compose([withAuth, withValidation(CustomerSchema)])(handler)` |
| 错误处理 | 统一抛出 `HttpError(status, message)`，由顶层捕获 |
| 响应封装 | `return jsonResponse(data, { status: 200 })`，包含 `data` 与 `meta` |
| 日志 | 使用结构化 JSON：`logger.info('customer.create', { id, userId })` |

> 建议使用 ESLint + Prettier，同时配置 `lint-staged` 保证提交质量。

---

## 3. 数据库最佳实践

1. **Prisma/Drizzle**：使用类型安全 ORM，避免手写 SQL。迁移按语义命名，例如 `20240501_add_followup_date`。
2. **索引优化**：为以下字段建立索引：
   - Customers：`phone`, `email`, `category`, `intention`, `created_at`
   - Products：`customerId`, `purchaseDate`, `followUpDate`
   - Visits：`customerId`, `visitTime`
3. **事务处理**：涉及多表写入（如删除客户级联）时使用事务，确保一致性。
4. **审计字段**：统一维护 `createdAt`, `updatedAt`; 使用 Prisma 中的 `@default(now())`, `@updatedAt`。
5. **数据隔离**：对敏感操作（备份、恢复）使用单独数据库角色，限制权限。

---

## 4. 性能优化

| 场景 | 建议 |
| --- | --- |
| 冷启动 | 减少函数体内 `require`/`import` 数量；使用轻量工具；缓存 ORM 客户端 |
| 大查询 | 使用分页、投影（`select`）、限制字段返回量 |
| 统计接口 | 预聚合或缓存短期数据（可使用 Vercel KV / Redis） |
| 前端 | 使用懒加载、按需加载图表库、压缩资源、HTTP/2 |
| CDN 缓存 | 静态资源默认由 Vercel CDN 缓存；对不常变化的 JSON 可设置 `Cache-Control` |

---

## 5. 安全策略

1. **输入校验**：所有写入接口均需通过 Zod/Yup 校验，禁止信任前端。
2. **JWT 安全**：
   - 使用强随机 `JWT_SECRET`（≥ 64 字符）。
   - Access Token 设置短有效期（15 分钟），Refresh Token 设置 7 天。
   - 登出可选实现 Token 黑名单（Upstash Redis）。
3. **加密存储**：
   - 使用 bcrypt（cost=10）或 argon2 加密密码。
   - 敏感配置（如备份存储密钥）使用 Vercel Secret 管理。
4. **安全头**：通过中间件设置 `HSTS`, `CSP`, `X-Frame-Options`, `X-Content-Type-Options`。
5. **速率限制**：对登录、敏感接口启用限流，防止暴力破解。
6. **依赖审核**：启用 `npm audit` 或 `pnpm audit`，定期更新依赖。

---

## 6. 测试策略

| 层级 | 工具 | 说明 |
| --- | --- | --- |
| 单元测试 | Vitest / Jest | 覆盖服务层与工具函数 |
| 接口测试 | Supertest + Vitest | 对 Serverless 函数进行集成测试 |
| 合同测试 | Pact（可选） | 保证前后端契约一致 |
| E2E 测试 | Playwright / Cypress | 覆盖核心用户路径（登录 → CRUD → 仪表盘） |
| 负载测试 | k6 / Artillery | 验证限流与性能表现 |

**最佳实践**：
- 通过 `npm run test -- --runInBand` 在 CI 中执行。
- 使用测试数据库（`DATABASE_URL` 指向 `ai_crm_test`）。
- 测试后自动清理数据。

---

## 7. 日志与监控

1. **统一日志格式**：
   ```json
   {
     "level": "info",
     "timestamp": "2024-05-06T10:00:00.123Z",
     "event": "customer.create",
     "userId": 1,
     "durationMs": 53
   }
   ```
2. **关键事件记录**：登录失败、删除操作、恢复备份等必须记录。
3. **错误追踪**：接入 Sentry 或类似服务，捕获未处理异常。
4. **性能指标**：统计 API 响应时间、数据库查询耗时，并设置阈值告警。
5. **健康检查**：提供 `/api/health` 接口，返回数据库连接状态与应用版本。

---

## 8. DevOps 与 CI/CD

1. **Git 分支策略**：`main`（生产）、`develop`（测试，可选）、`feature/*`（功能分支）。
2. **CI 流程**：推送代码触发以下步骤：
   - 安装依赖（使用缓存）。
   - Lint + Type Check。
   - 运行单元测试、集成测试。
   - 生成构建产物（如有）。
3. **CD 流程**：
   - 合并到 `main` 自动触发 Vercel 生产部署。
   - 每次部署记录在 `CHANGELOG.md`。
4. **基础设施即代码**：
   - 使用 `vercel.json` 管理函数配置。
   - 数据库迁移版本化管理。

---

## 9. 协作与文档

1. **需求追踪**：使用 `doc_move/` 文档作为单一可信来源；在任务看板中关联相关章节。
2. **代码评审**：
   - 每个 PR 至少由一名成员审批。
   - 强调逻辑正确性、边界条件处理、性能影响。
3. **知识库维护**：上线后将文档同步至内部 Wiki；定期更新 API 文档、ER 图。
4. **回顾总结**：每个迭代结束进行回顾，收集问题与改进建议。

---

## 10. 常见问题与解决方案

| 问题 | 可能原因 | 解决建议 |
| --- | --- | --- |
| Serverless 函数 504 | 外部 API 超时或数据库响应慢 | 增加超时处理，使用缓存或延迟队列 |
| Prisma 连接耗尽 | 冷启动频繁创建客户端 | 复用 PrismaClient，使用 Data Proxy |
| JWT 验证失败 | Secret 不一致或时间不同步 | 同步环境变量，确保服务器时间正确 |
| 备份文件过大 | 长期未清理备份 | 实现备份生命周期管理（保留最近 N 天） |
| 前端 CORS 报错 | 未配置 CORS Header | 在函数响应中添加 `Access-Control-Allow-Origin` |

---

## 11. 未来优化方向

1. **引入缓存层**：对频繁访问的数据使用 Upstash Redis 或 Vercel KV 缓存。
2. **自动化迁移**：结合 Prisma Migrate + Git Hooks 自动执行数据库升级。
3. **服务可视化**：集成 Grafana Cloud / Metabase 提供 BI 分析。
4. **AI 辅助**：利用 LLM 自动生成回访建议、识别客户意向变化。
5. **移动客户端**：基于 React Native 或 Flutter 开发配套移动 App。

---

本指南帮助开发团队在 Serverless 环境中保持高标准的工程实践，确保 AI-CRM 系统安全、稳定、可持续演进。
