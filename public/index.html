<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
  <title>登录 - AI-CRM 系统</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/tiny-pinyin.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/preview-mode.js"></script>
  <script src="js/pwa-register.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>
<body>
  <div class="login-shell" x-data="themeManager()" x-init="init()">
    <div class="dark-toggle">
      <button class="theme-toggle" @click="toggle()" type="button">
        <svg x-show="theme === 'light'" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
        <svg x-show="theme === 'dark'" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </button>
    </div>

    <div class="login-card" x-data="{ username: '', password: '', remember: false, error: '', loading: false }">
      <div class="login-card__header">
        <div class="login-logo">AI</div>
        <h1 class="login-title">AI-CRM 系统</h1>
        <p class="login-subtitle">智能客户关系管理平台</p>
      </div>

      <form class="login-form" @submit.prevent="
        loading = true;
        error = '';
        if (!username || !password) {
          error = '请输入用户名和密码';
          loading = false;
          return;
        }
        // 尝试调用后端 API 登录
        apiClient.setPreviewMode(false);
        apiClient.login(username, password)
          .then(() => {
            window.location.href = 'dashboard.html';
          })
          .catch((err) => {
            // 如果 API 不可用（如在 GitHub Pages 上），回退到预览模式
            const isFetchError = err.message && (
              err.message.includes('Failed to fetch') || 
              err.message.includes('NetworkError') || 
              err.message.includes('fetch') ||
              err.message.toLowerCase().includes('network')
            );
            
            if (isFetchError) {
              console.log('后端 API 不可用，进入预览模式');
              // 预览模式：允许任意登录
              apiClient.setPreviewMode(true);
              window.location.href = 'dashboard.html';
            } else {
              error = err.message || '登录失败，请检查用户名和密码';
              loading = false;
            }
          });
      ">
        <div x-show="error" x-transition class="tag tag-warning" style="width: 100%; justify-content: center;">
          <span x-text="error"></span>
        </div>

        <div class="field">
          <label class="field-label" for="username">用户名</label>
          <input 
            id="username"
            type="text" 
            class="input" 
            placeholder="请输入用户名" 
            x-model="username"
            :disabled="loading"
            autocomplete="username"
            required
          >
        </div>

        <div class="field">
          <label class="field-label" for="password">密码</label>
          <input 
            id="password"
            type="password" 
            class="input" 
            placeholder="请输入密码" 
            x-model="password"
            :disabled="loading"
            autocomplete="current-password"
            required
          >
        </div>

        <div class="form-action">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" x-model="remember" style="width: 16px; height: 16px;">
            <span>记住我</span>
          </label>
          <a href="#" style="color: var(--color-primary); font-weight: 600;">忘记密码？</a>
        </div>

        <button type="submit" class="btn" :disabled="loading">
          <span x-show="!loading">登录</span>
          <span x-show="loading">登录中...</span>
        </button>
      </form>

      <div class="login-footer">
        <p style="margin-bottom: 8px;">💡 如后端API可用，请使用：admin / admin123</p>
        <p>如无后端API（如GitHub Pages），输入任意账号即可进入演示模式</p>
      </div>
    </div>
  </div>
</body>
</html>
