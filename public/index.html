<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
  <title>ç™»å½• - AI-CRM ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/tiny-pinyin.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/preview-mode.js"></script>
  <script src="js/pwa-register.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <style>
    .install-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 30px;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.35);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      transition: all 0.3s ease;
      animation: pulse 2s ease-in-out infinite;
    }
    .install-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.45);
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .install-icon {
      font-size: 1.2rem;
    }
    @media (max-width: 640px) {
      .install-badge {
        top: 10px;
        right: 10px;
        padding: 10px 16px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="login-shell" x-data="{ ...themeManager(), showInstall: false, checkingInstall: true }" x-init="
    init();
    // æ£€æŸ¥å®‰è£…çŠ¶æ€
    fetch('/api/install/check-status')
      .then(res => res.json())
      .then(data => {
        showInstall = !data.installed;
      })
      .catch(() => {
        showInstall = true;
      })
      .finally(() => {
        checkingInstall = false;
      });
  ">
    <template x-if="!checkingInstall && showInstall">
      <a href="install.html" class="install-badge" x-transition.opacity.duration.300ms>
        <span class="install-icon">ğŸš€</span>
        <span>é¦–æ¬¡å®‰è£…å‘å¯¼</span>
      </a>
    </template>

    <div class="dark-toggle">
      <button class="theme-toggle" @click="toggle()" type="button">
        <svg x-show="theme === 'light'" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
        <svg x-show="theme === 'dark'" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </button>
    </div>

    <div class="login-card" x-data="{ username: '', password: '', remember: false, error: '', loading: false }">
      <div class="login-card__header">
        <div class="login-logo">AI</div>
        <h1 class="login-title">AI-CRM ç³»ç»Ÿ</h1>
        <p class="login-subtitle">æ™ºèƒ½å®¢æˆ·å…³ç³»ç®¡ç†å¹³å°</p>
      </div>

      <form class="login-form" @submit.prevent="
        loading = true;
        error = '';
        if (!username || !password) {
          error = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
          loading = false;
          return;
        }
        // å°è¯•è°ƒç”¨åç«¯ API ç™»å½•
        apiClient.setPreviewMode(false);
        apiClient.login(username, password)
          .then(() => {
            window.location.href = 'dashboard.html';
          })
          .catch((err) => {
            // å¦‚æœ API ä¸å¯ç”¨ï¼ˆå¦‚åœ¨ GitHub Pages ä¸Šï¼‰ï¼Œå›é€€åˆ°é¢„è§ˆæ¨¡å¼
            const status = typeof err === 'object' && err ? err.status : undefined;
            const message = typeof err === 'object' && err && typeof err.message === 'string' ? err.message : '';
            const normalizedMessage = message.toLowerCase();
            const isFetchError =
              normalizedMessage.includes('failed to fetch') ||
              normalizedMessage.includes('networkerror') ||
              normalizedMessage.includes('network request failed') ||
              normalizedMessage.includes('fetch') ||
              normalizedMessage.includes('network');
            const isApiUnavailableStatus = typeof status === 'number' && [404, 502, 503, 504].includes(status);

            if (isFetchError || isApiUnavailableStatus) {
              console.log('åç«¯ API ä¸å¯ç”¨ï¼Œè¿›å…¥é¢„è§ˆæ¨¡å¼', err);
              // é¢„è§ˆæ¨¡å¼ï¼šå…è®¸ä»»æ„ç™»å½•
              apiClient.setPreviewMode(true);
              window.location.href = 'dashboard.html';
            } else {
              error = message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
              loading = false;
            }
          });
      ">
        <div x-show="error" x-transition class="tag tag-warning" style="width: 100%; justify-content: center;">
          <span x-text="error"></span>
        </div>

        <div class="field">
          <label class="field-label" for="username">ç”¨æˆ·å</label>
          <input 
            id="username"
            type="text" 
            class="input" 
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
            x-model="username"
            :disabled="loading"
            autocomplete="username"
            required
          >
        </div>

        <div class="field">
          <label class="field-label" for="password">å¯†ç </label>
          <input 
            id="password"
            type="password" 
            class="input" 
            placeholder="è¯·è¾“å…¥å¯†ç " 
            x-model="password"
            :disabled="loading"
            autocomplete="current-password"
            required
          >
        </div>

        <div class="form-action">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="checkbox" x-model="remember" style="width: 16px; height: 16px;">
            <span>è®°ä½æˆ‘</span>
          </label>
          <a href="#" style="color: var(--color-primary); font-weight: 600;">å¿˜è®°å¯†ç ï¼Ÿ</a>
        </div>

        <button type="submit" class="btn" :disabled="loading">
          <span x-show="!loading">ç™»å½•</span>
          <span x-show="loading">ç™»å½•ä¸­...</span>
        </button>
      </form>

      <div class="login-footer">
        <p style="margin-bottom: 8px;">ğŸ’¡ å¦‚åç«¯APIå¯ç”¨ï¼Œè¯·ä½¿ç”¨ï¼šadmin / admin123</p>
        <p>å¦‚æ— åç«¯APIï¼ˆå¦‚GitHub Pagesï¼‰ï¼Œè¾“å…¥ä»»æ„è´¦å·å³å¯è¿›å…¥æ¼”ç¤ºæ¨¡å¼</p>
      </div>
    </div>
  </div>
</body>
</html>
