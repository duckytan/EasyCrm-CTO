<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <title>客户管理 - AI-CRM 系统</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/tiny-pinyin.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/auth-guard.js"></script>
  <script src="js/customers.js"></script>
  <script src="js/navbar-loader.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>
<body x-data="themeManager()" x-init="init()" data-page="customers">
  <div class="app-shell">
    <div id="navbar-container"></div>

    <!-- 主内容区 -->
    <div class="content-area">
      <!-- 顶部栏 -->
      <header class="top-bar">
        <h1 class="top-bar__title">客户管理</h1>
        <div class="top-bar__actions">
          <button class="theme-toggle" @click="toggle()" type="button">
            <svg x-show="theme === 'light'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <svg x-show="theme === 'dark'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- 页面内容 -->
      <main class="page-content" x-data="customersPage()" x-init="init()">
        <!-- 加载状态 -->
        <template x-if="loading">
          <div class="section">
            <div class="card" style="text-align: center; padding: 32px;">
              <p>数据加载中...</p>
            </div>
          </div>
        </template>

        <!-- 错误状态 -->
        <template x-if="error">
          <div class="section">
            <div class="card" style="text-align: center; padding: 24px; color: #EF4444;">
              <p x-text="error"></p>
            </div>
          </div>
        </template>

        <!-- 主内容 -->
        <template x-if="!loading && !error">
          <div>
            <!-- 搜索和过滤 -->
            <section class="section">
              <div class="search-bar">
                <input 
                  type="search" 
                  class="input" 
                  placeholder="搜索客户姓名、公司、电话、邮箱等..." 
                  x-model="search"
                  @input.debounce.500ms="searchCustomers()"
                  style="flex: 2; min-width: 200px;"
                >
                <select class="select" x-model="filterCategory" @change="filterCustomers()" style="flex: 1;">
                  <option value="">全部分类</option>
                  <template x-for="cat in categories" :key="cat.id">
                    <option :value="cat.id" x-text="cat.name"></option>
                  </template>
                </select>
                <select class="select" x-model="filterIntention" @change="filterCustomers()" style="flex: 1;">
                  <option value="">全部意向</option>
                  <template x-for="intent in intentions" :key="intent.id">
                    <option :value="intent.level" x-text="intent.name"></option>
                  </template>
                </select>
              </div>
            </section>

            <!-- 统计卡片 -->
            <section class="section">
              <div class="grid-three">
                <div class="card">
                  <div class="stat-label">总客户数</div>
                  <div class="stat-value" x-text="stats.total"></div>
                </div>
                <div class="card">
                  <div class="stat-label">本月新增</div>
                  <div class="stat-value" x-text="stats.monthlyNew"></div>
                </div>
                <div class="card">
                  <div class="stat-label">待回访</div>
                  <div class="stat-value" x-text="stats.pendingVisits"></div>
                </div>
              </div>
            </section>

            <!-- 客户列表 -->
            <section class="section">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                <h2 class="section-title" style="margin: 0;">客户列表 <span style="color: var(--color-text-muted); font-weight: 400; font-size: 0.875rem;">（共 <span x-text="pagination.total"></span> 条）</span></h2>
                <button class="btn" style="padding: 10px 16px; font-size: 0.875rem;" @click="openCreateModal()">
                  <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  新增客户
                </button>
              </div>

              <template x-if="customers.length === 0">
                <div class="empty-state">
                  <p>未找到匹配的客户</p>
                </div>
              </template>

              <div class="customer-grid" x-show="customers.length > 0">
                <template x-for="customer in customers" :key="customer.id">
                  <div class="customer-card">
                    <div class="customer-card__header">
                      <div class="avatar" x-text="customer.avatar"></div>
                      <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 2px;" x-text="customer.name"></div>
                        <div style="font-size: 0.8rem; color: var(--color-text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="customer.company || '未填写公司'"></div>
                      </div>
                    </div>

                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                      <span class="tag" x-text="customer.categoryName || '未分类'"></span>
                      <span class="tag tag-warning" x-text="customer.intentionName || '未设置意向'"></span>
                    </div>

                    <div style="font-size: 0.85rem; color: var(--color-text-muted); display: flex; flex-direction: column; gap: 6px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                        </svg>
                        <span x-text="customer.phone || '未留电话'"></span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21.2 8.4c.5.38.8.97.8 1.6v10a2 2 0 01-2 2H4a2 2 0 01-2-2V10c0-.63.3-1.22.8-1.6l8-6a2 2 0 012.4 0l8 6z"/>
                          <path d="m22 10-8.97 5.7a1.94 1.94 0 01-2.06 0L2 10"/>
                        </svg>
                        <span x-text="customer.email || '未留邮箱'" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>最近回访：<span x-text="formatDate(customer.lastVisit)"></span></span>
                      </div>
                    </div>

                    <div class="inline-actions">
                      <a :href="`customer-detail.html?id=${customer.id}`" class="btn" style="flex: 1; padding: 10px; font-size: 0.875rem;">查看详情</a>
                      <button class="btn btn-ghost" style="flex: 1; padding: 10px; font-size: 0.875rem;" @click="openEditModal(customer)">编辑</button>
                      <button class="btn btn-ghost" style="padding: 10px; font-size: 0.875rem;" @click="deleteCustomer(customer.id, customer.name)">删除</button>
                    </div>
                  </div>
                </template>
              </div>

              <div class="pagination" x-show="pagination.totalPages > 1" style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 20px;">
                <button class="btn btn-ghost" :disabled="pagination.page === 1" @click="changePage(pagination.page - 1)" style="padding: 8px 14px;">
                  上一页
                </button>
                <div style="font-size: 0.9rem; color: var(--color-text-muted);">
                  第 <span x-text="pagination.page"></span> / <span x-text="pagination.totalPages"></span> 页
                </div>
                <button class="btn btn-ghost" :disabled="pagination.page === pagination.totalPages" @click="changePage(pagination.page + 1)" style="padding: 8px 14px;">
                  下一页
                </button>
              </div>
            </section>
          </div>
        </template>

        <template x-if="showModal">
          <div class="modal-overlay" x-transition @click.self="closeModal()">
            <form class="modal-content" @submit.prevent="submitForm()">
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                <h2 class="modal-title" x-text="modalMode === 'create' ? '新增客户' : '编辑客户'"></h2>
                <button type="button" @click="closeModal()" style="background: none; border: none; color: var(--color-text-muted); cursor: pointer; padding: 4px;">
                  <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                  </svg>
                </button>
              </div>

              <div class="modal-body">
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label required" for="customer-name">客户姓名</label>
                    <input id="customer-name" type="text" class="input" placeholder="请输入客户姓名" x-model="formData.name">
                    <template x-if="formErrors.name">
                      <div class="form-error" x-text="formErrors.name"></div>
                    </template>
                  </div>

                  <div class="form-group">
                    <label class="form-label required" for="customer-phone">联系电话</label>
                    <input id="customer-phone" type="text" class="input" placeholder="请输入联系电话" x-model="formData.phone">
                    <template x-if="formErrors.phone">
                      <div class="form-error" x-text="formErrors.phone"></div>
                    </template>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-email">客户邮箱</label>
                    <input id="customer-email" type="email" class="input" placeholder="请输入邮箱" x-model="formData.email">
                    <template x-if="formErrors.email">
                      <div class="form-error" x-text="formErrors.email"></div>
                    </template>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-company">所在公司</label>
                    <input id="customer-company" type="text" class="input" placeholder="请输入公司名称" x-model="formData.company">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-category">客户分类</label>
                    <select id="customer-category" class="select" x-model="formData.customerCategoryId">
                      <option value="">未分类</option>
                      <template x-for="cat in categories" :key="cat.id">
                        <option :value="cat.id" x-text="cat.name"></option>
                      </template>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-intention">意向等级</label>
                    <select id="customer-intention" class="select" x-model="formData.customerIntentionLevel">
                      <option value="">未设置</option>
                      <template x-for="intent in intentions" :key="intent.id">
                        <option :value="intent.level" x-text="intent.name"></option>
                      </template>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-region">所属地区</label>
                    <select id="customer-region" class="select" x-model="formData.regionId">
                      <option value="">未设置</option>
                      <template x-for="region in regions" :key="region.id">
                        <option :value="region.id" x-text="region.name"></option>
                      </template>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-budget">预算范围</label>
                    <select id="customer-budget" class="select" x-model="formData.budgetRangeId">
                      <option value="">未设置</option>
                      <template x-for="item in budgetRanges" :key="item.id">
                        <option :value="item.id" x-text="item.name"></option>
                      </template>
                    </select>
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-address">联系地址</label>
                    <input id="customer-address" type="text" class="input" placeholder="请输入联系地址" x-model="formData.address">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-birthday">生日</label>
                    <input id="customer-birthday" type="date" class="input" x-model="formData.birthday">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-wechat">微信</label>
                    <input id="customer-wechat" type="text" class="input" placeholder="微信号" x-model="formData.wechat">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="customer-whatsapp">WhatsApp</label>
                    <input id="customer-whatsapp" type="text" class="input" placeholder="WhatsApp账号" x-model="formData.whatsapp">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="planned-visit-date">计划回访日期</label>
                    <input id="planned-visit-date" type="date" class="input" x-model="formData.plannedVisitDate">
                  </div>

                  <div class="form-group">
                    <label class="form-label" for="planned-visit-method">计划回访方式</label>
                    <select id="planned-visit-method" class="select" x-model="formData.plannedVisitMethodId">
                      <option value="">未设置</option>
                      <template x-for="method in visitMethods" :key="method.id">
                        <option :value="method.id" x-text="method.name"></option>
                      </template>
                    </select>
                  </div>

                  <div class="form-group full-width">
                    <label class="form-label" for="customer-demand">客户需求</label>
                    <textarea id="customer-demand" class="textarea" rows="3" placeholder="简要描述客户需求" x-model="formData.demand"></textarea>
                  </div>

                  <div class="form-group full-width">
                    <label class="form-label" for="planned-visit-content">回访计划内容</label>
                    <textarea id="planned-visit-content" class="textarea" rows="3" placeholder="请输入回访计划内容" x-model="formData.plannedVisitContent"></textarea>
                  </div>

                  <div class="form-group full-width">
                    <label class="form-label" for="customer-remark">备注信息</label>
                    <textarea id="customer-remark" class="textarea" rows="3" placeholder="其他补充说明" x-model="formData.remark"></textarea>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-ghost" @click="closeModal()" :disabled="modalLoading">取消</button>
                <button type="submit" class="btn" :disabled="modalLoading">
                  <span x-show="!modalLoading">保存</span>
                  <span x-show="modalLoading">正在保存...</span>
                </button>
              </div>
            </form>
          </div>
        </template>
      </main>
    </div>
  </div>
</body>
</html>
