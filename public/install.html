<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" sizes="192x192" href="icons/icon-192x192.png">
  <title>ç³»ç»Ÿå®‰è£…å‘å¯¼ - AI-CRM</title>
  <link rel="stylesheet" href="css/base.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    [x-cloak] {
      display: none !important;
    }
    .install-wrapper {
      max-width: 900px;
      width: 100%;
    }
    .install-container {
      background: var(--color-bg-primary);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .install-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    .install-header h1 {
      font-size: 2rem;
      margin: 0 0 0.5rem 0;
      color: white;
    }
    .install-header p {
      margin: 0;
      opacity: 0.95;
      font-size: 1.05rem;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      padding: 1.5rem 2rem;
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0 1rem;
      font-size: 0.9rem;
      color: var(--color-text-secondary);
    }
    .step-item.active {
      color: #667eea;
      font-weight: 600;
    }
    .step-item.completed {
      color: #10b981;
    }
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--color-bg-tertiary, #374151);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .step-item.active .step-number {
      background: #667eea;
      color: white;
    }
    .step-item.completed .step-number {
      background: #10b981;
      color: white;
    }
    .install-content {
      padding: 2.5rem;
      min-height: 400px;
    }
    .step-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-primary);
    }
    .step-desc {
      color: var(--color-text-secondary);
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }
    .form-label .required {
      color: #ef4444;
      margin-left: 0.25rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      transition: all 0.2s;
    }
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-input.error {
      border-color: #ef4444;
    }
    .form-error {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .form-hint {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    @media (max-width: 640px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .alert {
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 0.75rem;
    }
    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid #10b981;
      color: #10b981;
    }
    .alert-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid #f59e0b;
      color: #d97706;
    }
    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid #3b82f6;
      color: #2563eb;
    }
    .check-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-bottom: 0.75rem;
      transition: border-color 0.2s, background 0.2s;
    }
    .check-item.success {
      border-color: rgba(16, 185, 129, 0.4);
      background: rgba(16, 185, 129, 0.08);
    }
    .check-item.error {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(239, 68, 68, 0.08);
    }
    .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }
    .check-icon.success {
      background: #10b981;
      color: white;
    }
    .check-icon.error {
      background: #ef4444;
      color: white;
    }
    .check-icon.loading {
      background: #3b82f6;
      color: white;
      animation: spin 1s linear infinite;
    }
    .check-detail {
      margin-top: 0.25rem;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      line-height: 1.5;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .check-content {
      flex: 1;
    }
    .check-title {
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: 0.25rem;
    }
    .check-desc {
      font-size: 0.875rem;
      color: var(--color-text-secondary);
    }
    .install-actions {
      display: flex;
      justify-content: space-between;
      padding: 1.5rem 2.5rem;
      background: var(--color-bg-secondary);
      border-top: 1px solid var(--color-border);
    }
    .btn-secondary {
      background: var(--color-bg-tertiary, #374151);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
    }
    .btn-secondary:hover:not(:disabled) {
      background: #4b5563;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .progress-steps {
      margin: 2rem 0;
    }
    .progress-step {
      display: flex;
      align-items: start;
      gap: 1rem;
      padding: 1rem;
      border-left: 3px solid var(--color-border);
      margin-bottom: 1rem;
    }
    .progress-step.success {
      border-left-color: #10b981;
    }
    .progress-step.error {
      border-left-color: #ef4444;
    }
    .progress-step.pending {
      border-left-color: #6b7280;
    }
    .progress-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }
    .progress-icon.success {
      background: #10b981;
      color: white;
    }
    .progress-icon.error {
      background: #ef4444;
      color: white;
    }
    .progress-icon.pending {
      background: #6b7280;
      color: white;
    }
    .progress-icon.loading {
      background: #3b82f6;
      color: white;
      animation: spin 1s linear infinite;
    }
    .success-icon {
      font-size: 4rem;
      text-align: center;
      margin: 2rem 0;
    }
    .install-lock {
      text-align: center;
      padding: 2rem 0;
    }
    .lock-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>
<body>
  <div class="install-wrapper" x-data="installWizard()" x-init="init()">
    <div class="install-container" x-show="!checking" x-cloak>
      <div class="install-header">
        <h1>ğŸš€ AI-CRM ç³»ç»Ÿå®‰è£…å‘å¯¼</h1>
        <p>æ¬¢è¿ï¼è®©æˆ‘ä»¬ä¸€èµ·å®Œæˆç³»ç»Ÿå®‰è£…é…ç½®</p>
      </div>

      <template x-if="installed">
        <div>
          <div class="install-content">
            <div class="install-lock">
              <div class="lock-icon">ğŸ”’</div>
              <h2 class="step-title">ç³»ç»Ÿå·²å®‰è£…</h2>
              <p class="step-desc">æ£€æµ‹åˆ°ç³»ç»Ÿå·²å®‰è£…å¹¶é…ç½®å®Œæˆï¼Œå®‰è£…å‘å¯¼å·²é”å®šã€‚<br>å¦‚éœ€é‡æ–°å®‰è£…ï¼Œè¯·å…ˆæ¸…ç©ºæ•°æ®åº“ã€‚</p>
              <a href="index.html" class="btn">è¿”å›ç™»å½•</a>
            </div>
          </div>
        </div>
      </template>

      <template x-if="!installed">
        <div>
          <div class="step-indicator">
            <div class="step-item" :class="{ 'active': step === 1, 'completed': step > 1 }">
              <div class="step-number">1</div>
              <span>ç¯å¢ƒæ£€æŸ¥</span>
            </div>
            <div class="step-item" :class="{ 'active': step === 2, 'completed': step > 2 }">
              <div class="step-number">2</div>
              <span>æ•°æ®åº“é…ç½®</span>
            </div>
            <div class="step-item" :class="{ 'active': step === 3, 'completed': step > 3 }">
              <div class="step-number">3</div>
              <span>ç³»ç»Ÿè®¾ç½®</span>
            </div>
            <div class="step-item" :class="{ 'active': step === 4, 'completed': step > 4 }">
              <div class="step-number">4</div>
              <span>æ‰§è¡Œå®‰è£…</span>
            </div>
            <div class="step-item" :class="{ 'active': step === 5 }">
              <div class="step-number">5</div>
              <span>å®‰è£…å®Œæˆ</span>
            </div>
          </div>

          <div class="install-content">
            <!-- æ­¥éª¤1: ç¯å¢ƒæ£€æŸ¥ -->
            <div x-show="step === 1">
              <h2 class="step-title">ç¯å¢ƒæ£€æŸ¥</h2>
              <p class="step-desc">æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿè¿è¡Œç¯å¢ƒæ˜¯å¦æ»¡è¶³å®‰è£…è¦æ±‚...</p>

              <!-- åŠ è½½çŠ¶æ€ -->
              <template x-if="envCheckLoading">
                <div class="alert alert-info">
                  <span>â³</span>
                  <span>æ­£åœ¨æ£€æŸ¥ç¯å¢ƒ...</span>
                </div>
              </template>

              <!-- API è¯·æ±‚å¤±è´¥æ—¶çš„é”™è¯¯æç¤º -->
              <template x-if="envCheckError && !envCheckLoading">
                <div class="alert alert-error">
                  <span>âš ï¸</span>
                  <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">æ— æ³•è·å–ç¯å¢ƒæ£€æŸ¥ç»“æœ</div>
                    <div x-text="envCheckError" style="margin-bottom: 0.5rem;"></div>
                    <button @click="checkEnvironment" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-top: 0.5rem;" :disabled="envCheckLoading">
                      <span x-show="!envCheckLoading">ğŸ”„ é‡æ–°æ£€æŸ¥</span>
                      <span x-show="envCheckLoading">æ£€æŸ¥ä¸­...</span>
                    </button>
                  </div>
                </div>
              </template>

              <!-- æ£€æŸ¥ç»“æœåˆ—è¡¨ -->
              <template x-if="!envCheckLoading && !envCheckError">
                <div>
                  <!-- æ±‡æ€»ä¿¡æ¯ -->
                  <template x-if="envCheckSummary">
                    <div class="alert" :class="envCheckPassed ? 'alert-success' : 'alert-warning'" style="margin-bottom: 1rem;">
                      <span x-text="envCheckPassed ? 'âœ“' : 'â„¹ï¸'"></span>
                      <div>
                        <span x-text="`æ£€æŸ¥å®Œæˆ: ${envCheckSummary.passed}/${envCheckSummary.total} é¡¹é€šè¿‡`"></span>
                        <template x-if="!envCheckPassed">
                          <span x-text="`, ${envCheckSummary.failed} é¡¹éœ€è¦å¤„ç†`"></span>
                        </template>
                      </div>
                    </div>
                  </template>

                  <ul class="check-list">
                    <template x-for="check in envChecks" :key="check.key">
                      <li class="check-item" :class="check.passed ? 'success' : 'error'">
                        <div class="check-icon" :class="check.passed ? 'success' : 'error'">
                          <span x-text="check.passed ? 'âœ“' : 'âœ—'"></span>
                        </div>
                        <div class="check-content">
                          <div class="check-title" x-text="check.required"></div>
                          <div class="check-desc" x-text="check.message"></div>
                          <div class="check-detail" x-show="check.detail" x-text="check.detail"></div>
                        </div>
                      </li>
                    </template>
                  </ul>

                  <!-- æ£€æŸ¥æœªé€šè¿‡çš„æç¤º -->
                  <template x-if="!envCheckPassed">
                    <div class="alert alert-error">
                      <span>âš ï¸</span>
                      <div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">ç¯å¢ƒæ£€æŸ¥æœªé€šè¿‡</div>
                        <div style="margin-bottom: 0.5rem;">è¯·æ ¹æ®ä¸Šè¿°æç¤ºä¿®å¤ç¯å¢ƒé—®é¢˜åï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡æ–°æ£€æŸ¥ã€‚</div>
                        <button @click="checkEnvironment" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem; margin-top: 0.5rem;" :disabled="envCheckLoading">
                          <span x-show="!envCheckLoading">ğŸ”„ é‡æ–°æ£€æŸ¥</span>
                          <span x-show="envCheckLoading">æ£€æŸ¥ä¸­...</span>
                        </button>
                      </div>
                    </div>
                  </template>

                  <!-- æ£€æŸ¥é€šè¿‡çš„æç¤º -->
                  <template x-if="envCheckPassed">
                    <div class="alert alert-success">
                      <span>âœ“</span>
                      <span>ç¯å¢ƒæ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­è¿›è¡Œå®‰è£…ï¼</span>
                    </div>
                  </template>
                </div>
              </template>
            </div>

            <!-- æ­¥éª¤2: æ•°æ®åº“é…ç½® -->
            <div x-show="step === 2">
              <h2 class="step-title">æ•°æ®åº“é…ç½®</h2>
              <p class="step-desc">è¯·é…ç½® PostgreSQL æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œç³»ç»Ÿå°†ä½¿ç”¨æ­¤æ•°æ®åº“å­˜å‚¨æ•°æ®ã€‚</p>

              <div class="alert alert-info" x-show="!dbTestResult">
                <span>ğŸ’¡</span>
                <span>è¯·ç¡®ä¿å·²åˆ›å»ºç©ºçš„ PostgreSQL æ•°æ®åº“ã€‚é…ç½®å®Œæˆåå¯æµ‹è¯•è¿æ¥ã€‚</span>
              </div>

              <div class="alert alert-success" x-show="dbTestResult === 'success'">
                <span>âœ“</span>
                <span>æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼</span>
              </div>

              <div class="alert alert-error" x-show="dbTestResult === 'error'">
                <span>âœ—</span>
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥</div>
                  <div x-text="dbTestError" style="white-space: pre-line;"></div>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">æ•°æ®åº“ä¸»æœº<span class="required">*</span></label>
                  <input type="text" class="form-input" x-model="database.host" placeholder="localhost">
                  <div class="form-hint">æœ¬åœ°å¼€å‘ä½¿ç”¨ localhost</div>
                </div>
                <div class="form-group">
                  <label class="form-label">ç«¯å£<span class="required">*</span></label>
                  <input type="number" class="form-input" x-model.number="database.port" placeholder="5432">
                  <div class="form-hint">PostgreSQL é»˜è®¤ç«¯å£ 5432</div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">æ•°æ®åº“åç§°<span class="required">*</span></label>
                <input type="text" class="form-input" x-model="database.database" placeholder="ai_crm">
                <div class="form-hint">è¯·å…ˆåœ¨ PostgreSQL ä¸­åˆ›å»ºæ­¤æ•°æ®åº“</div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">ç”¨æˆ·å<span class="required">*</span></label>
                  <input type="text" class="form-input" x-model="database.username" placeholder="postgres">
                </div>
                <div class="form-group">
                  <label class="form-label">å¯†ç </label>
                  <input type="password" class="form-input" x-model="database.password" placeholder="æ•°æ®åº“å¯†ç ">
                </div>
              </div>

              <button @click="testDatabase" class="btn" style="margin-top: 1rem;" :disabled="dbTesting">
                <span x-show="!dbTesting">ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥</span>
                <span x-show="dbTesting">æµ‹è¯•ä¸­...</span>
              </button>
            </div>

            <!-- æ­¥éª¤3: ç³»ç»Ÿè®¾ç½® -->
            <div x-show="step === 3">
              <h2 class="step-title">ç³»ç»Ÿè®¾ç½®</h2>
              <p class="step-desc">é…ç½®ç³»ç»ŸåŸºæœ¬ä¿¡æ¯å’Œç®¡ç†å‘˜è´¦æˆ·ã€‚</p>

              <h3 style="font-size: 1.1rem; margin: 2rem 0 1rem 0; color: var(--color-text-primary);">ğŸ“ ç³»ç»Ÿä¿¡æ¯</h3>
              
              <div class="form-group">
                <label class="form-label">ç³»ç»Ÿåç§°</label>
                <input type="text" class="form-input" x-model="system.projectName" placeholder="AI-CRM æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ">
              </div>

              <div class="form-group">
                <label class="form-label">ç³»ç»Ÿæè¿°</label>
                <input type="text" class="form-input" x-model="system.projectDescription" placeholder="åŸºäºAIçš„æ™ºèƒ½å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿ">
              </div>

              <div class="form-group">
                <label class="form-label">è®¿é—®åœ°å€</label>
                <input type="url" class="form-input" x-model="system.projectUrl" placeholder="http://localhost:3000">
                <div class="form-hint">ç³»ç»Ÿè®¿é—®URLï¼ˆç”¨äºç”Ÿæˆé“¾æ¥ç­‰ï¼‰</div>
              </div>

              <h3 style="font-size: 1.1rem; margin: 2rem 0 1rem 0; color: var(--color-text-primary);">ğŸ‘¤ ç®¡ç†å‘˜è´¦æˆ·</h3>

              <div class="form-group">
                <label class="form-label">ç™»å½•ç”¨æˆ·å<span class="required">*</span></label>
                <input type="text" class="form-input" x-model="admin.username" placeholder="admin" 
                       :class="{ 'error': adminErrors.username }">
                <div class="form-error" x-show="adminErrors.username" x-text="adminErrors.username"></div>
                <div class="form-hint" x-show="!adminErrors.username">3-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
              </div>

              <div class="form-group">
                <label class="form-label">æ˜¾ç¤ºåç§°<span class="required">*</span></label>
                <input type="text" class="form-input" x-model="admin.displayName" placeholder="ç³»ç»Ÿç®¡ç†å‘˜"
                       :class="{ 'error': adminErrors.displayName }">
                <div class="form-error" x-show="adminErrors.displayName" x-text="adminErrors.displayName"></div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">å¯†ç <span class="required">*</span></label>
                  <input type="password" class="form-input" x-model="admin.password" placeholder="è¯·è¾“å…¥å¯†ç "
                         :class="{ 'error': adminErrors.password }">
                  <div class="form-error" x-show="adminErrors.password" x-text="adminErrors.password"></div>
                  <div class="form-hint" x-show="!adminErrors.password">è‡³å°‘6ä¸ªå­—ç¬¦</div>
                </div>
                <div class="form-group">
                  <label class="form-label">ç¡®è®¤å¯†ç <span class="required">*</span></label>
                  <input type="password" class="form-input" x-model="adminPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç "
                         :class="{ 'error': adminErrors.passwordConfirm }">
                  <div class="form-error" x-show="adminErrors.passwordConfirm" x-text="adminErrors.passwordConfirm"></div>
                </div>
              </div>
            </div>

            <!-- æ­¥éª¤4: æ‰§è¡Œå®‰è£… -->
            <div x-show="step === 4">
              <h2 class="step-title">æ‰§è¡Œå®‰è£…</h2>
              <p class="step-desc">ç³»ç»Ÿæ­£åœ¨å®‰è£…ï¼Œè¯·ç¨å€™...</p>

              <div class="progress-steps">
                <template x-for="(installStep, index) in installSteps" :key="index">
                  <div class="progress-step" :class="installStep.status">
                    <div class="progress-icon" :class="installStep.status">
                      <span x-show="installStep.status === 'success'">âœ“</span>
                      <span x-show="installStep.status === 'error'">âœ—</span>
                      <span x-show="installStep.status === 'pending'">â—‹</span>
                      <span x-show="installStep.status === 'loading'">â—</span>
                    </div>
                    <div>
                      <div class="check-title" x-text="installStep.name"></div>
                      <div class="check-desc" x-text="installStep.message"></div>
                    </div>
                  </div>
                </template>
              </div>

              <div class="alert alert-error" x-show="installError">
                <span>âš ï¸</span>
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.25rem;">å®‰è£…å¤±è´¥</div>
                  <div x-text="installError"></div>
                </div>
              </div>
            </div>

            <!-- æ­¥éª¤5: å®‰è£…å®Œæˆ -->
            <div x-show="step === 5">
              <div class="success-icon">ğŸ‰</div>
              <h2 class="step-title" style="text-align: center;">å®‰è£…å®Œæˆï¼</h2>
              <p class="step-desc" style="text-align: center;">
                æ­å–œï¼AI-CRM ç³»ç»Ÿå·²æˆåŠŸå®‰è£…ã€‚<br>
                æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨åˆšæ‰åˆ›å»ºçš„ç®¡ç†å‘˜è´¦æˆ·ç™»å½•ç³»ç»Ÿã€‚
              </p>

              <div class="alert alert-success">
                <span>âœ“</span>
                <div>
                  <div style="font-weight: 600; margin-bottom: 0.5rem;">ç™»å½•ä¿¡æ¯</div>
                  <div style="font-family: monospace;">
                    ç”¨æˆ·å: <span x-text="admin.username"></span><br>
                    å¯†ç : ******ï¼ˆæ‚¨åˆšæ‰è®¾ç½®çš„å¯†ç ï¼‰
                  </div>
                </div>
              </div>

              <div style="text-align: center; margin-top: 2rem;">
                <a href="index.html" class="btn">å‰å¾€ç™»å½•</a>
              </div>
            </div>
          </div>

          <div class="install-actions" x-show="step < 5">
            <button @click="prevStep" class="btn btn-secondary" :disabled="step === 1 || installing">
              â† ä¸Šä¸€æ­¥
            </button>
            <button @click="nextStep" class="btn" :disabled="!canProceed || installing">
              <span x-show="step < 4">ä¸‹ä¸€æ­¥ â†’</span>
              <span x-show="step === 4">å¼€å§‹å®‰è£…</span>
            </button>
          </div>
        </div>
      </template>
    </div>

    <div x-show="checking" style="text-align: center; color: white;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">â³</div>
      <div style="font-size: 1.2rem;">æ­£åœ¨æ£€æŸ¥å®‰è£…çŠ¶æ€...</div>
    </div>
  </div>

  <script>
    function installWizard() {
      return {
        checking: true,
        installed: false,
        step: 1,
        installing: false,
        
        // ç¯å¢ƒæ£€æŸ¥
        envChecks: [],
        envCheckPassed: false,
        envCheckLoading: false,
        envCheckError: '',
        envCheckSummary: null,
        
        // æ•°æ®åº“é…ç½®
        database: {
          host: 'localhost',
          port: 5432,
          database: 'ai_crm',
          username: 'postgres',
          password: ''
        },
        dbTesting: false,
        dbTestResult: null,
        dbTestError: '',
        
        // ç³»ç»Ÿé…ç½®
        system: {
          projectName: 'AI-CRM æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ',
          projectDescription: 'åŸºäºAIçš„æ™ºèƒ½å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿ',
          projectUrl: window.location.origin
        },
        
        // ç®¡ç†å‘˜é…ç½®
        admin: {
          username: 'admin',
          displayName: 'ç³»ç»Ÿç®¡ç†å‘˜',
          password: ''
        },
        adminPasswordConfirm: '',
        adminErrors: {},
        
        // å®‰è£…æ­¥éª¤
        installSteps: [
          { name: 'æµ‹è¯•æ•°æ®åº“è¿æ¥', status: 'pending', message: '' },
          { name: 'åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶', status: 'pending', message: '' },
          { name: 'åˆå§‹åŒ–æ•°æ®åº“ç»“æ„', status: 'pending', message: '' },
          { name: 'åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·', status: 'pending', message: '' }
        ],
        installError: '',
        
        async init() {
          try {
            const res = await fetch('/api/install/check-status');
            const data = await res.json();
            this.installed = data.installed;
            
            if (!this.installed) {
              await this.checkEnvironment();
            }
          } catch (error) {
            console.error('æ£€æŸ¥å®‰è£…çŠ¶æ€å¤±è´¥:', error);
          } finally {
            this.checking = false;
          }
        },
        
        async checkEnvironment() {
          this.envCheckLoading = true;
          this.envCheckError = '';
          this.envCheckPassed = false;
          
          try {
            const res = await fetch('/api/install/check-env');
            let data = null;
            
            try {
              data = await res.json();
            } catch (parseError) {
              console.error('è§£æç¯å¢ƒæ£€æŸ¥ç»“æœå¤±è´¥:', parseError);
            }
            
            if (!res.ok) {
              const message = (data && (data.message || data.error)) || `HTTP ${res.status}: ${res.statusText}`;
              throw new Error(message);
            }
            
            if (!data) {
              throw new Error('ç¯å¢ƒæ£€æŸ¥è¿”å›äº†ç©ºæ•°æ®ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
            
            const checksArray = this.transformEnvChecks(data.checks);
            this.envChecks = checksArray;
            this.envCheckPassed = Boolean(data.success);
            this.envCheckSummary = this.buildEnvSummary(data.summary, checksArray);
            
            if (!checksArray.length && !this.envCheckPassed) {
              this.envCheckError = data.message || 'æœªè·å–åˆ°ç¯å¢ƒæ£€æŸ¥é¡¹ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ã€‚';
              this.envCheckSummary = null;
            }
          } catch (error) {
            console.error('ç¯å¢ƒæ£€æŸ¥å¤±è´¥:', error);
            const message = error instanceof Error
              ? error.message
              : 'ç¯å¢ƒæ£€æŸ¥è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€';
            this.envCheckError = message;
            this.envChecks = [];
            this.envCheckSummary = null;
            this.envCheckPassed = false;
          } finally {
            this.envCheckLoading = false;
          }
        },
        
        // è½¬æ¢ç¯å¢ƒæ£€æŸ¥ç»“æœï¼ˆä»å¯¹è±¡è½¬ä¸ºæ•°ç»„ï¼‰
        transformEnvChecks(checks) {
          if (!checks || typeof checks !== 'object') {
            return [];
          }
          const order = ['nodeVersion', 'nodeModules', 'prismaSchema', 'envExample', 'writable'];
          const orderIndex = (key) => {
            const index = order.indexOf(key);
            return index === -1 ? order.length : index;
          };
          return Object.entries(checks)
            .map(([key, check]) => ({
              key,
              required: check?.required ?? key,
              message: check?.message ?? '',
              detail: check?.detail ?? '',
              passed: Boolean(check?.passed),
            }))
            .sort((a, b) => orderIndex(a.key) - orderIndex(b.key));
        },
        
        // æ„å»ºæ±‡æ€»ä¿¡æ¯
        buildEnvSummary(summary, checksArray) {
          const total = checksArray.length;
          const passed = checksArray.filter((c) => c.passed).length;
          const failed = total - passed;
          
          if (summary && typeof summary === 'object') {
            return {
              total: typeof summary.total === 'number' ? summary.total : total,
              passed: typeof summary.passed === 'number' ? summary.passed : passed,
              failed: typeof summary.failed === 'number' ? summary.failed : failed,
            };
          }
          
          return { total, passed, failed };
        },
        
        async testDatabase() {
          this.dbTesting = true;
          this.dbTestResult = null;
          this.dbTestError = '';
          
          try {
            const res = await fetch('/api/install/test-db', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.database)
            });
            
            const data = await res.json();
            
            if (data.success) {
              this.dbTestResult = 'success';
            } else {
              this.dbTestResult = 'error';
              this.dbTestError = data.message || data.error || 'æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®';
            }
          } catch (error) {
            this.dbTestResult = 'error';
            this.dbTestError = 'è¯·æ±‚å¤±è´¥: ' + (error.message || 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
          } finally {
            this.dbTesting = false;
          }
        },
        
        validateAdmin() {
          this.adminErrors = {};
          let valid = true;
          
          if (!this.admin.username || !/^[a-zA-Z0-9_]{3,20}$/.test(this.admin.username)) {
            this.adminErrors.username = 'ç”¨æˆ·åæ ¼å¼æ— æ•ˆï¼ˆ3-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼‰';
            valid = false;
          }
          
          if (!this.admin.displayName || this.admin.displayName.trim().length === 0) {
            this.adminErrors.displayName = 'æ˜¾ç¤ºåç§°ä¸èƒ½ä¸ºç©º';
            valid = false;
          }
          
          if (!this.admin.password || this.admin.password.length < 6) {
            this.adminErrors.password = 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦';
            valid = false;
          }
          
          if (this.admin.password !== this.adminPasswordConfirm) {
            this.adminErrors.passwordConfirm = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
            valid = false;
          }
          
          return valid;
        },
        
        async executeInstall() {
          this.installing = true;
          this.installError = '';
          
          this.installSteps.forEach(step => {
            step.status = 'pending';
            step.message = '';
          });
          
          try {
            const res = await fetch('/api/install/execute', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                database: this.database,
                admin: this.admin,
                system: this.system
              })
            });
            
            const data = await res.json();
            
            if (data.success && data.steps) {
              this.installSteps = data.steps;
              setTimeout(() => {
                this.step = 5;
              }, 1000);
            } else {
              // æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
              const errorMessage = data.message || data.error || 'å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°æœªçŸ¥é”™è¯¯';
              this.installError = errorMessage;
              
              // å¦‚æœè¿”å›äº†æ­¥éª¤ä¿¡æ¯ï¼Œä½¿ç”¨è¿”å›çš„æ­¥éª¤çŠ¶æ€
              if (data.steps && Array.isArray(data.steps)) {
                this.installSteps = data.steps;
              } else {
                // å¦åˆ™åœ¨ç¬¬ä¸€æ­¥æ ‡è®°é”™è¯¯
                this.installSteps[0].status = 'error';
                this.installSteps[0].message = errorMessage;
              }
            }
          } catch (error) {
            const message = error instanceof Error 
              ? error.message 
              : 'æœªçŸ¥é”™è¯¯';
            this.installError = 'å®‰è£…è¯·æ±‚å¤±è´¥: ' + message + 'ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€ã€‚';
            this.installSteps[0].status = 'error';
            this.installSteps[0].message = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
          } finally {
            this.installing = false;
          }
        },
        
        get canProceed() {
          if (this.step === 1) {
            return this.envCheckPassed && !this.envCheckLoading && !this.envCheckError;
          } else if (this.step === 2) {
            return this.dbTestResult === 'success' && !this.dbTesting;
          } else if (this.step === 3) {
            return this.validateAdmin();
          }
          return true;
        },
        
        prevStep() {
          if (this.step > 1) {
            this.step--;
          }
        },
        
        async nextStep() {
          if (this.step === 3) {
            if (!this.validateAdmin()) {
              return;
            }
          }
          
          if (this.step === 4) {
            await this.executeInstall();
          } else {
            this.step++;
          }
        }
      };
    }
  </script>
</body>
</html>
