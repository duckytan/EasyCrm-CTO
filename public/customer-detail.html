<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
  <title>客户详情 - AI-CRM 系统</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/tiny-pinyin.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/auth-guard.js"></script>
  <script src="js/customer-detail.js"></script>
  <script src="js/navbar-loader.js"></script>
  <script src="js/pwa-register.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>
<body x-data="themeManager()" x-init="init()" data-page="customers">
  <div class="app-shell">
    <div id="navbar-container"></div>

    <div class="content-area">
      <header class="top-bar">
        <div>
          <a href="customers.html" style="display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--color-text-muted);">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"/>
            </svg>
            返回客户列表
          </a>
          <h1 class="top-bar__title" style="margin-top: 6px;">客户详情</h1>
        </div>
        <div class="top-bar__actions">
          <button class="theme-toggle" @click="toggle()" type="button">
            <svg x-show="theme === 'light'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <svg x-show="theme === 'dark'" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
          </button>
          <button class="btn btn-ghost" style="padding: 10px 16px; font-size: 0.85rem;" @click="alert('编辑功能待实现')">编辑</button>
        </div>
      </header>

      <main class="page-content" x-data="customerDetailPage()" x-init="init()">
        <!-- 加载状态 -->
        <template x-if="loading">
          <div class="section">
            <div class="card" style="text-align: center; padding: 32px;">
              <p>数据加载中...</p>
            </div>
          </div>
        </template>

        <!-- 错误状态 -->
        <template x-if="error">
          <div class="section">
            <div class="card" style="text-align: center; padding: 24px; color: #EF4444;">
              <p x-text="error"></p>
              <button class="btn" style="margin-top: 16px;" @click="goBack()">返回客户列表</button>
            </div>
          </div>
        </template>

        <!-- 主内容 -->
        <template x-if="!loading && !error && customer">
          <div>
            <section class="section">
              <div class="card" style="display: flex; flex-direction: column; gap: 18px;">
                <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">
                  <div class="avatar" style="width: 60px; height: 60px; font-size: 1.4rem;" x-text="customer.avatar"></div>
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                      <h2 style="margin: 0; font-size: 1.4rem; font-weight: 700;" x-text="customer.name"></h2>
                      <span class="tag" x-text="customer.categoryName || '未分类'"></span>
                      <span class="tag tag-warning" x-text="customer.intentionName || '未设置意向'"></span>
                    </div>
                    <div style="margin-top: 6px; color: var(--color-text-muted); font-size: 0.9rem;" x-text="customer.company || '未填写公司信息'"></div>
                  </div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn" style="padding: 10px 16px; font-size: 0.85rem;" @click="createVisit()">创建回访</button>
                    <button class="btn btn-ghost" style="padding: 10px 16px; font-size: 0.85rem;" @click="createOrder()">创建订单</button>
                  </div>
                </div>

                <div class="info-grid">
                  <div class="info-cell">
                    <div class="info-label">联系电话</div>
                    <div class="info-value" x-text="customer.phone || '未填写'"></div>
                  </div>
                  <div class="info-cell">
                    <div class="info-label">客户邮箱</div>
                    <div class="info-value" x-text="customer.email || '未填写'"></div>
                  </div>
                  <div class="info-cell">
                    <div class="info-label">所属地区</div>
                    <div class="info-value" x-text="customer.regionName || '未填写'"></div>
                  </div>
                  <div class="info-cell">
                    <div class="info-label">最近回访</div>
                    <div class="info-value" x-text="customer.lastVisit ? formatDate(customer.lastVisit) : '暂无'"></div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Tabs -->
        <section class="section">
          <div class="card">
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
              <button class="btn" :class="tab === 'overview' ? '' : 'btn-ghost'" @click="changeTab('overview')"><span>基本信息</span></button>
              <button class="btn" :class="tab === 'visits' ? '' : 'btn-ghost'" @click="changeTab('visits')"><span>回访记录</span></button>
              <button class="btn" :class="tab === 'orders' ? '' : 'btn-ghost'" @click="changeTab('orders')"><span>产品订单</span></button>
            </div>

            <div x-show="tab === 'overview'" x-transition>
              <div style="display: grid; gap: 16px;">
                <div>
                  <div class="info-label">客户需求</div>
                  <p style="margin-top: 6px; line-height: 1.6; color: var(--color-text-muted);" x-text="customer.demand || '暂无需求描述'"></p>
                </div>
                <div>
                  <div class="info-label">沟通渠道</div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    <template x-if="communicationChannels.length === 0">
                      <span class="tag">暂无</span>
                    </template>
                    <template x-for="channel in communicationChannels" :key="channel">
                      <span class="tag" x-text="channel"></span>
                    </template>
                  </div>
                </div>
                <div>
                  <div class="info-label">下次计划</div>
                  <div style="margin-top: 6px; color: var(--color-text-muted);">
                    <template x-if="nextPlan">
                      <span>
                        <span x-text="nextPlan.date"></span>
                        <span> · </span>
                        <span x-text="nextPlan.method"></span>
                        <span> · </span>
                        <span x-text="nextPlan.content"></span>
                      </span>
                    </template>
                    <template x-if="!nextPlan">
                      <span>暂无计划</span>
                    </template>
                  </div>
                </div>
                <div>
                  <div class="info-label">备注</div>
                  <p style="margin-top: 6px; line-height: 1.6; color: var(--color-text-muted);" x-text="customer.remark || '暂无备注'"></p>
                </div>
                <div>
                  <div class="info-label">地址</div>
                  <p style="margin-top: 6px; line-height: 1.6; color: var(--color-text-muted);" x-text="customer.address || '未填写地址'"></p>
                </div>
              </div>
            </div>

            <div x-show="tab === 'visits'" x-transition class="timeline">
              <template x-if="visits.length === 0">
                <div class="empty-state">暂无回访记录</div>
              </template>

              <template x-for="visit in visits" :key="visit.id">
                <div class="timeline-item">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 600;" x-text="visit.visitTime"></div>
                    <span class="tag" x-text="visit.type"></span>
                  </div>
                  <div style="margin-top: 8px; color: var(--color-text-muted); line-height: 1.6;" x-text="visit.content"></div>
                  <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <template x-if="visit.effect">
                      <span class="tag tag-success">效果：<span x-text="visit.effect"></span></span>
                    </template>
                    <template x-if="visit.intention">
                      <span class="tag tag-warning">意向：<span x-text="visit.intention"></span></span>
                    </template>
                  </div>
                  <template x-if="visit.followUp">
                    <div style="margin-top: 8px; font-size: 0.85rem; color: var(--color-text-muted);">
                      下一步：<span x-text="visit.followUp"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>

            <div x-show="tab === 'orders'" x-transition>
              <template x-if="orders.length === 0">
                <div class="empty-state">暂无产品订单</div>
              </template>

              <template x-for="order in orders" :key="order.id">
                <div class="card" style="margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; gap: 12px;">
                    <div>
                      <h3 style="margin: 0; font-size: 1rem; font-weight: 600;" x-text="order.productName"></h3>
                      <div style="margin-top: 6px; color: var(--color-text-muted); font-size: 0.85rem;">
                        购买日期：<span x-text="formatDate(order.purchaseDate)"></span>
                      </div>
                      <div style="margin-top: 4px; color: var(--color-text-muted); font-size: 0.85rem;">
                        跟进日期：<span x-text="formatDate(order.followUpDate)"></span>
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 1.1rem; font-weight: 700;" x-text="formatCurrency(order.total)"></div>
                      <div style="margin-top: 6px; color: var(--color-text-muted); font-size: 0.85rem;">
                        数量：<span x-text="order.quantity"></span> · 单价 <span x-text="formatCurrency(order.price)"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
</body>
</html>
